<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>World Bank Data & Sammenligning & Grafer</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    .controls, #graphControls { display: flex; gap: .5em; flex-wrap: wrap; align-items: center; margin-bottom: 1rem; }
    select, button, input[type="text"] { font-size: 1rem; padding: .5em; }
    .table-container { overflow-x: auto; }
    table { border-collapse: collapse; width: max-content; min-width: 100%; margin-top: 1rem; }
    th, td { border: 1px solid #ddd; padding: .5em; text-align: center; white-space: nowrap; }
    th { background: #f2f2f2; }
    tr:nth-child(even) { background: #fafafa; }
    canvas#chart { max-width: 700px; max-height: 400px; width: 100%; height: auto; margin-top: 1rem; }
    /* Modal styling */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
    .modal-content { background: #fff; margin: 5% auto; padding: 1rem; border-radius: 4px; width: 80%; max-width: 600px; max-height: 80%; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; }
    .modal-body { margin-top: 1rem; columns: 3; column-gap: 1rem; }
    .modal-body label { display: block; margin-bottom: .25em; }
    .modal-footer { margin-top: 1em; text-align: right; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <h1>World Bank Data & Sammenligning & Grafer</h1>

  <div class="controls">
    <label>Land 1:
      <select id="country1"><option value="" disabled selected>‚Äì v√¶lg land ‚Äì</option></select>
    </label>
    <label>Land 2 (valgfri):
      <select id="country2"><option value="" disabled selected>‚Äì v√¶lg land ‚Äì</option></select>
    </label>
    <button id="openYearModal" type="button">V√¶lg √•r</button>
    <button id="btnFetch">Hent data</button>
    <button id="btnExcel" disabled>Download Excel (Land 1)</button>
    <button id="btnGraphs">Lav grafer</button>
<button id="btnGlobalExplorer" type="button">Global Udforsker</button>
<button id="btnCorrelation" type="button">Korrelations-analyse</button>
  </div>

  <div id="tableContainer" class="table-container"></div>

  <div id="graphSection" style="display: none;">
    <h2>Graf-v√¶rkt√∏j (Land 1)</h2>
    <div id="graphControls">
      <input type="text" id="filterInput" placeholder="S√∏g indikator‚Ä¶" disabled />
      <select id="indicatorSelect" multiple size="8" disabled></select>
      <select id="yearSelect" multiple size="6" disabled></select>
      <button id="last5Btn" disabled>Seneste 5 √•r</button>
      <button id="last10Btn" disabled>Seneste 10 √•r</button>
      <button id="plotBtn" disabled>Tegn graf</button>
    </div>
    <canvas id="chart"></canvas>
  </div>

  <div id="giniSection" style="display: none; margin-top: 2rem; max-width: 700px;">
    <h2>Analyse af Indkomstulighed (Land 1)</h2>

    <div id="giniActualData">
      <p id="giniIntroText">Henter Gini-data...</p>
      <canvas id="lorenzChartActual" height="200"></canvas>
    </div>

    <div id="giniSimulation" style="margin-top: 2rem; border-top: 2px solid #eee; padding-top: 1rem;">
      <h3>Sandkasse: Test udviklingsscenarier</h3>
      <p>Hvordan ville f√∏lgende h√¶ndelser p√•virke uligheden i et land som det valgte? (modellen er generisk)</p>
      <div id="simulationControls" style="display: flex; flex-wrap: wrap; gap: 0.5em; margin-bottom: 1rem;">
    <button data-scenario="mikrolaan">Succes med mikrol√•n üìà</button>
    <button data-scenario="uddannelse">Investering i grunduddannelse üßë‚Äçüè´</button>
    <button data-scenario="fairtrade">Fairtrade-aftale for b√∏nder ‚òï</button>
    <button data-scenario="landgrabbing" style="background-color: #fee;">Opk√∏b af landbrugsjord üìâ</button>
    <button data-scenario="korruption" style="background-color: #fee;">Korruption med ulandsbistand üí∞</button>

    <button data-scenario="fdi">Flere udenlandske investeringer (FDI) üè≠</button>
    <button data-scenario="demokrati">Mere demokratisk lovgivning üó≥Ô∏è</button>
    <button data-scenario="mereBistand">Mere ulandsbistand (effektiv) üí∏</button>
    <button data-scenario="mindreBistand" style="background-color: #fee;">Mindre ulandsbistand üíî</button>
    <button data-scenario="offentligInvest">Flere offentlige investeringer üèóÔ∏è</button>

    <button data-scenario="reset">Nulstil model</button>
</div>
      <canvas id="lorenzChartSimulation" height="200"></canvas>
      <p id="scenarioFeedback" style="min-height: 4em; background-color: #f8f8f8; padding: 0.5em; border-radius: 4px;"></p>
    </div>
  </div>
<div id="correlationSection" style="display: none; margin-top: 2rem; max-width: 900px;">
    <h2>Korrelations-analyse (Tidsserie)</h2>
    <p>Unders√∏g sammenh√¶ngen mellem to n√∏gletal for et enkelt land over en given √•rr√¶kke.</p>
    
    <div class="controls" id="correlationControls" style="align-items: flex-start; gap: 1.5rem;">
      <div style="display: flex; flex-direction: column; gap: .5rem;">
        <label for="correlationCountry">1. V√¶lg land:</label>
        <select id="correlationCountry" style="width: 250px;"></select>
        
        <label for="correlationYearFrom">3. V√¶lg √•rr√¶kke:</label>
        <div>
          <input type="text" id="correlationYearFrom" value="1990" style="width: 60px;">
          <span> til </span>
          <input type="text" id="correlationYearTo" value="2023" style="width: 60px;">
        </div>
      </div>
      
      <div style="display: flex; flex-direction: column; gap: .5rem; flex-grow: 1;">
        <label for="correlationX">2. V√¶lg X-akse (uafh√¶ngig variabel):</label>
        <select id="correlationX" style="width: 100%;"></select>
        
        <label for="correlationY">2. V√¶lg Y-akse (afh√¶ngig variabel):</label>
        <select id="correlationY" style="width: 100%;"></select>
      </div>

      <button id="correlationRunBtn" type="button" style="height: 4rem; align-self: center;">Analyser</button>
    </div>
    
    <div id="correlationStats" style="margin-top: 1rem; font-size: 1.2rem; text-align: center; background: #f4f4f4; padding: 1rem; border-radius: 4px; display: none;">
      </div>

    <div style="margin-top: 1rem; height: 500px; position: relative;">
       <canvas id="correlationChart"></canvas>
    </div>
  </div>

  <div id="yearModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>V√¶lg √Ör</h3>
        <button id="closeYearModal" style="font-size:1.2rem;">‚úñ</button>
      </div>
      <div>
        <button id="selectAllYears" type="button">V√¶lg alle</button>
        <button id="clearAllYears" type="button">Frav√¶lg alle</button>
        <input type="text" id="yearSearch" placeholder="S√∏g √•r‚Ä¶" style="margin-left:1rem; padding:.3em; width:150px;" />
      </div>
      <div class="modal-body" id="yearList"></div>
      <div class="modal-footer">
        <button id="applyYears" type="button">OK</button>
      </div>
    </div>
  </div>
<div id="explorerSection" style="display: none; margin-top: 2rem; max-width: 100%;">
    <h2>Global Udforsker</h2>
    <p>Find top 10 og bund 10 lande for et n√∏gletal, baseret p√• det senest tilg√¶ngelige data for hvert land.</p>
    
    <div class="controls" id="explorerControls">
      <label for="explorerIndicatorSelect">V√¶lg n√∏gletal:</label>
      <select id="explorerIndicatorSelect" style="width: 350px;"></select>
      <button id="explorerRunBtn" type="button">Analyser</button>
    </div>
    
    <div id="explorerSnapshot" style="margin-top: 1rem; font-size: 1.2rem; text-align: center; background: #f4f4f4; padding: 1rem; border-radius: 4px;">
      V√¶lg et n√∏gletal og tryk 'Analyser'
    </div>

    <div style="display: flex; flex-wrap: wrap; gap: 2rem; margin-top: 1rem;">
       <div style="flex: 1; min-width: 400px; height: 400px; position: relative;">
         <canvas id="explorerChartTop10"></canvas>
       </div>
       <div style="flex: 1; min-width: 400px; height: 400px; position: relative;">
         <canvas id="explorerChartBottom10"></canvas>
       </div>
    </div>
  </div>
    <footer style="display:flex; justify-content:space-between; font-size:0.8em; margin:2rem 0 0 0;">
    <div class="left-footer" style="text-align:left;">
      The World Bank. (2025). World Development Indicators. Hentet d. 11 november 2025 fra https://api.worldbank.org/v2/country/{land}/indicator/{indikator}?format=json
    </div>
    <div class="right-footer" style="text-align:right;">
      &copy; Allan Baisgaard, Aalborg Handelsgymnasie, Tur√∏gade
    </div>
  </footer>

  <script>
    // Konfiguration
    // const proxyUrl = ''; // IKKE L√ÜNGERE N√òDVENDIG
    // const apiBase  = '...'; // IKKE L√ÜNGERE N√òDVENDIG
    // const params   = '...'; // IKKE L√ÜNGERE N√òDVENDIG
    
    // Denne globale variabel vil indeholde ALLE vores data
    let worldBankData = {};

    // Indikatorer (vi beholder denne, da hele app'en er bygget op om den)
    const indicators = [
      { code: 'AG.LND.TOTL.K2',    name: 'Areal (kvadratkilometer)' },
      { code: 'SP.POP.GROW',        name: 'Befolkningstilv√¶ksten (√•rlig %)' },
      { code: 'SP.URB.TOTL.IN.ZS',  name: 'Urban befolkning (% af befolkningen)' },
      { code: 'SP.URB.GROW',        name: 'Urban befolkningsv√¶kst (√•rlig %)' },
      { code: 'NY.GDP.MKTP.KD.ZG',  name: 'BNP-v√¶kst (√•rlig %)' },
      { code: 'NY.GDP.PCAP.KD',     name: 'BNP per indbygger (konstant 2015 US$)' },
      { code: 'NY.GDP.PCAP.PP.KD',  name: 'BNP per indbygger, PPP (konstant 2021 $)' },
      { code: 'NY.GDP.PCAP.KD.ZG',  name: 'BNP per indbygger v√¶kst (√•rlig %)' },
      { code: 'NE.GDI.FTOT.ZS',     name: 'Offentlige investeringer i % af BNP' },
      { code: 'FP.CPI.TOTL.ZG',     name: 'Inflation, forbrugerpriser (√•rlig %)' },
      { code: 'SL.UEM.TOTL.ZS',     name: 'Arbejdsl√∏shed, samlet (% af arbejdskraft)' },
      { code: 'SI.POV.GINI',        name: 'Gini-indeks' },
      { code: 'SI.DST.10TH.10',     name: 'Indkomstandel √∏verste 10%' },
      { code: 'SI.DST.05TH.20',     name: 'Indkomstandel √∏verste 20%' },
      { code: 'SI.DST.FRST.10',     name: 'Indkomstandel nederste 10%' },
      { code: 'SI.DST.FRST.20',     name: 'Indkomstandel nederste 20%' },
      { code: 'SP.DYN.LE00.IN',     name: 'Forventet levealder ved f√∏dslen, samlet (√•r)' },
      { code: 'SP.DYN.LE00.MA.IN',  name: 'Forventet levealder ved f√∏dslen, m√¶nd (√•r)' },
      { code: 'SP.DYN.LE00.FE.IN',  name: 'Forventet levealder ved f√∏dslen, kvinder (√•r)' },
      { code: 'SP.DYN.CBRT.IN',     name: 'F√∏dselsraten i promille' },
      { code: 'SP.DYN.CDRT.IN',     name: 'D√∏draten i promille' },
      { code: 'SP.DYN.IMRT.IN',     name: 'Sp√¶db√∏rnsd√∏delighed (pr. 1.000)' },
      { code: 'SH.DYN.MORT',        name: 'D√∏delighed under 5 √•r (pr. 1.000)' },
      { code: 'SP.DYN.TFRT.IN',     name: 'Fertilitetsraten (f√∏dsler/kvinde)' },
      { code: 'SL.AGR.EMPL.ZS',     name: 'Antal besk√¶ftigede i prim√¶re erhverv' },
      { code: 'NV.AGR.TOTL.ZS',     name: 'Prim√¶re erhvervs v√¶rditilv√¶kst (% af BNP)' },
      { code: 'SL.IND.EMPL.ZS',     name: 'Antal besk√¶ftigede i det sekund√¶re erhverv' },
      { code: 'NV.IND.TOTL.ZS',     name: 'Sekund√¶r erhvervs v√¶rditilv√¶kst (% af BNP)' },
      { code: 'SL.SRV.EMPL.ZS',     name: 'Antal besk√¶ftigede i det terti√¶re erhverv' },
      { code: 'NV.SRV.TOTL.ZS',     name: 'Terti√¶re erhvervs v√¶rditilv√¶kst (% af BNP)' },
      { code: 'SH.MED.PHYS.ZS',     name: 'L√¶ger (pr. 1.000 indb.)' },
      { code: 'SH.MED.BEDS.ZS',     name: 'Hospitalssenge (pr. 1.000 indb.)' },
      { code: 'SE.COM.DURS',        name: 'Varighed obligatorisk uddannelse (√•r)' },
      { code: 'SH.STA.BRTC.ZS',     name: 'F√∏dsler assisteret af sundhedspersonale (%)' },
      { code: 'EN.GHG.CO2.ZG.AR5',  name: 'CO‚ÇÇ-udledning (% √¶ndring fra 1990)' },
      { code: 'IT.NET.BBND.P2',     name: 'Bredb√•ndsabonnementer (pr. 100 pers.)' },
      { code: 'IT.MLT.MAIN.P2',     name: 'Fastnettelefonabonn. (pr. 100 pers.)' },
      { code: 'IT.CEL.SETS.P2',     name: 'Mobilabonnementer (pr. 100 pers.)' },
      { code: 'EG.ELC.ACCS.ZS',     name: 'Adgang til elektricitet (%)' },
      { code: 'EG.ELC.ACCS.RU.ZS',  name: 'Adgang til elektricitet, landdistrikter (%)' },
      { code: 'EG.ELC.ACCS.UR.ZS',  name: 'Adgang til elektricitet, byer (%)' },
      { code: 'SH.H2O.BASW.ZS',     name: 'Grundl√¶ggende drikkevandsservice (%)' },
      { code: 'SH.H2O.SMDW.ZS',     name: 'Sikkert forvaltet drikkevand (%)' },
      { code: 'SH.H2O.SMDW.RU.ZS',  name: 'Sikkert forvaltet drikkevand, landdistr. (%)' },
      { code: 'SH.H2O.SMDW.UR.ZS',  name: 'Sikkert forvaltet drikkevand, byer (%)' }
    ];

    // Globale variabler
    let years = [];
    for (let y = 1960; y <= 2024; y++) years.push(String(y));
    let selectedYears = [...years];
    let latest1, latest2, graphChart;
    let initialCountryGiniData = null;
// *** START RETTELSE: G√∏r graf-instanser globale ***
    let explorerChartTop10Instance, explorerChartBottom10Instance;
    let correlationChartInstance; 
    // *** SLUT RETTELSE ***

    // *** √ÜNDRING 1: HELE SIDENS START-LOGIK ***
    // Alt starter nu med at hente vores lokale JSON-fil
    document.addEventListener('DOMContentLoaded', () => {
      // S√¶t UI op, der ikke kr√¶ver data
      initializeYearModal();
      document.getElementById('tableContainer').innerHTML = 'Indl√¶ser datafil...';

      // Start det ENESTE netv√¶rkskald: Hent den lokale fil
      fetch('worldbank_data.json') // S√∏rg for at filen hedder dette!
        .then(res => {
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          return res.json();
        })
        .then(data => {
          // SUCCES! Gem data i den globale variabel
          worldBankData = data;
          
          // K√∏r funktioner, der er afh√¶ngige af data:
          populateCountryDropdowns(); 
          
          // Klarg√∏r "Hent data"-knappen
          
          
          // Resten af knapperne
          document.getElementById('btnExcel').onclick = downloadExcel;
          document.getElementById('btnGraphs').onclick = onGraphsClick;
          document.getElementById('btnGini').onclick = showGiniSection;
          populateExplorerDropdown(); // 1. Fyld den nye dropdown-menu
          
          // 2. T√¶nd for "Analyser"-knappen
          document.getElementById('explorerRunBtn').onclick = runGlobalAnalysis;

          // 3. H√•ndter vis/skjul af sektioner
          document.getElementById('btnGlobalExplorer').onclick = () => {
            document.getElementById('explorerSection').style.display = 'block';
            document.getElementById('tableContainer').innerHTML = ''; // Ryd tabel
            document.getElementById('graphSection').style.display = 'none';
            document.getElementById('giniSection').style.display = 'none';
          };
          
          // 4. Skjul udforskeren, hvis man trykker "Hent data"
          document.getElementById('btnFetch').onclick = () => {
             document.getElementById('explorerSection').style.display = 'none';
             onFetchClick(); // Kald den oprindelige funktion
          };
          // *** SLUT: TILF√òJ DISSE 4 LINJER ***
// *** START: TILF√òJ DISSE 4 LINJER TIL KORRELATION ***
          populateCorrelationDropdowns(); // Fyld lande/indikatorer
          
          document.getElementById('correlationRunBtn').onclick = runCorrelationAnalysis;
          
          document.getElementById('btnCorrelation').onclick = () => {
            document.getElementById('correlationSection').style.display = 'block';
            document.getElementById('explorerSection').style.display = 'none';
            document.getElementById('tableContainer').innerHTML = '';
            document.getElementById('graphSection').style.display = 'none';
            document.getElementById('giniSection').style.display = 'none';
          };
          // *** SLUT: TILF√òJ DISSE 4 LINJER TIL KORRELATION ***

          document.getElementById('tableContainer').innerHTML = ''; // Ryd "Indl√¶ser..."
        })
        .catch(err => {
          console.error("FEJL: Kunne ikke indl√¶se 'worldbank_data.json'", err);
          document.getElementById('tableContainer').innerHTML = `
            <h2 style="color:red;">KRITISK FEJL</h2>
            <p>Kunne ikke indl√¶se 'worldbank_data.json'.</p>
            <p>S√∏rg for, at filen er genereret af Python-scriptet og uploadet til samme mappe som denne HTML-fil.</p>`;
        });
    });

    // *** √ÜNDRING 2: NY "HENT DATA"-KNAP LOGIK ***
    // Denne funktion erstatter den gamle anonyme .onclick
    // Bem√¶rk: Den er ikke "async", den k√∏rer √òJEBLIKKELIGT.
    function onFetchClick() {
      const c1 = document.getElementById('country1').value;
      const c2 = document.getElementById('country2').value;
      if (!c1) return alert('V√¶lg venligst mindst √©t land.');

      document.getElementById('tableContainer').innerHTML = 'Genererer tabel...';
      const c1Name = document.getElementById('country1').options[document.getElementById('country1').selectedIndex].text;
      const c2Name = c2 ? document.getElementById('country2').options[document.getElementById('country2').selectedIndex].text : '';

      // Vi fjerner alt med "Promise.all", da fetchRaw nu er √∏jeblikkelig
      if (c2) {
        const p1 = fetchRaw(c1); // K√∏rer med det samme
        const p2 = fetchRaw(c2); // K√∏rer med det samme
        
        latest1 = p1; latest2 = p2;
        const yearsUnion = [...new Set([...p1.years, ...p2.years])].sort();
        p1.years = yearsUnion; p2.years = yearsUnion;
        document.getElementById('tableContainer').innerHTML = '';
        document.getElementById('tableContainer').append(buildComparison(p1, p2, c1Name, c2Name));
        document.getElementById('btnExcel').disabled = false;
      } else {
        const p = fetchRaw(c1); // K√∏rer med det samme
        
        latest1 = p; latest2 = null;
        document.getElementById('tableContainer').innerHTML = '';
        document.getElementById('tableContainer').append(buildTable(p));
        document.getElementById('btnExcel').disabled = false;
      }
    };

    // *** √ÜNDRING 3: populateCountryDropdowns Omskrivning ***
    // Bruger nu data fra 'worldBankData' i stedet for at lave et netv√¶rkskald
    function populateCountryDropdowns() {
      const countries = worldBankData.metadata.countries; // Hent fra vores JSON
      const c1Select = document.getElementById('country1');
      const c2Select = document.getElementById('country2');

      // Sorter lande alfabetisk efter navn (value)
      const sortedCountries = Object.entries(countries)
          .sort(([, nameA], [, nameB]) => nameA.localeCompare(nameB));

      for (const [id, name] of sortedCountries) {
        c1Select.append(new Option(name, id));
        c2Select.append(new Option(name, id));
      }
    }

    function initializeYearModal() {
      const modal = document.getElementById('yearModal');
      const list = document.getElementById('yearList');
      const search = document.getElementById('yearSearch');

      function renderList(filter = '') {
        list.innerHTML = '';
        years.filter(y => y.includes(filter)).forEach(y => {
          const lbl = document.createElement('label');
          const cb = document.createElement('input'); cb.type = 'checkbox'; cb.value = y;
          cb.checked = selectedYears.includes(y);
          lbl.append(cb, ' ', y);
          list.append(lbl);
        });
      }
      renderList();

      document.getElementById('openYearModal').onclick = () => { modal.style.display = 'block'; search.value=''; renderList(); };
      document.getElementById('closeYearModal').onclick = () => modal.style.display = 'none';
      document.getElementById('selectAllYears').onclick = () => { selectedYears = [...years]; renderList(search.value); };
      document.getElementById('clearAllYears').onclick = () => { selectedYears = []; renderList(search.value); };
      search.oninput = () => renderList(search.value);
      document.getElementById('applyYears').onclick = () => {
        selectedYears = Array.from(list.querySelectorAll('input[type=\"checkbox\"]:checked')).map(cb => cb.value);
        modal.style.display = 'none';
      };
      window.onclick = e => { if (e.target === modal) modal.style.display = 'none'; };
    }

    // *** √ÜNDRING 4: fetchRaw Omskrivning ***
    // Denne funktion er ikke l√¶ngere "async". Den er √∏jeblikkelig.
    // Den laver ikke netv√¶rkskald, men sl√•r op i 'worldBankData'.
    function fetchRaw(country) {
      const dataMap = {};
      
      // Hent landets data fra vores globale objekt
      // Vi tjekker, om landet overhovedet findes i vores data
      const countryData = worldBankData.data[country] || {}; 

      indicators.forEach(ind => {
        dataMap[ind.code] = {};
        
        // Fyld dataMap med "null" for alle valgte √•r (pr√¶cis som f√∏r)
        selectedYears.forEach(y => dataMap[ind.code][y] = null); 
        
        // Find data for denne specifikke indikator
        const indicatorData = countryData[ind.code] || {};

        // Fyld de v√¶rdier ind, vi rent faktisk har
        selectedYears.forEach(y => {
          if (indicatorData[y] != null) { // Tjek for 'not null/undefined'
            dataMap[ind.code][y] = indicatorData[y];
          }
        });
      });
      
      // Returner PR√ÜCIS den samme struktur som f√∏r
      return { years: selectedYears, dataMap };
    }

    // --- INGEN √ÜNDRINGER N√òDVENDIGE UNDER DENNE LINJE ---
    // Alle funktionerne nedenfor (buildTable, Gini-simulator, etc.)
    // er U√ÜNDREDE, da de kun er afh√¶ngige af strukturen fra 'fetchRaw',
    // som vi har genskabt perfekt.
    // --- --- --- --- --- --- --- --- --- --- --- --- ---

    function buildTable(p) {
      const tbl = document.createElement('table');
      const yearsToShow = p.years && p.years.length ? p.years : selectedYears;
      const head = tbl.createTHead().insertRow();
      head.insertCell().textContent = 'N√∏gletal \\ √Ör';
      yearsToShow.forEach(y => head.insertCell().textContent = y);
      const body = tbl.createTBody();
      indicators.forEach(ind => {
        const row = body.insertRow(); row.insertCell().textContent = ind.name;
        yearsToShow.forEach(y => {
          const v = p.dataMap[ind.code] ? p.dataMap[ind.code][y] : null;
          row.insertCell().textContent = v != null ? v.toFixed(2) : '‚Äì';
        });
      });
      return tbl;
    }

    function buildComparison(p1, p2, c1, c2) {
      const tbl = document.createElement('table');
      const head = tbl.createTHead();
      const r1 = head.insertRow(); r1.insertCell().rowSpan=2; r1.cells[0].textContent='N√∏gletal \\ √Ör';
      p1.years.forEach(y=>{ const c=r1.insertCell(); c.colSpan=2; c.textContent=y; });
      const r2 = head.insertRow(); p1.years.forEach(_=>{ r2.insertCell().textContent=c1; r2.insertCell().textContent=c2; });
      const body = tbl.createTBody();
      indicators.forEach(ind=>{
        const row = body.insertRow(); row.insertCell().textContent=ind.name;
        p1.years.forEach(y=>{
          const v1 = p1.dataMap[ind.code][y], v2 = p2.dataMap[ind.code][y];
          row.insertCell().textContent = v1!=null? v1.toFixed(2):'‚Äì';
          row.insertCell().textContent = v2!=null? v2.toFixed(2):'‚Äì';
        });
      });
      return tbl;
    }

    function downloadExcel() {
      if (!latest1) return alert('Ingen data at downloade');
      const aoa = [['N√∏gletal \\ √Ör', ...latest1.years]];
      indicators.forEach(ind=>{
        const row=[ind.name]; latest1.years.forEach(y=>{ const v=latest1.dataMap[ind.code][y]; row.push(v!=null?+v.toFixed(2):null); });
        aoa.push(row);
      });
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(aoa);
      XLSX.utils.book_append_sheet(wb, ws, 'Data');
      XLSX.writeFile(wb, `WorldBank_${document.getElementById('country1').value}.xlsx`);
    }

    function populateGraphControls() {
      const fi  = document.getElementById('filterInput');
      const iS  = document.getElementById('indicatorSelect');
      const yS  = document.getElementById('yearSelect');
      [fi, iS, yS,
       document.getElementById('last5Btn'),
       document.getElementById('last10Btn'),
       document.getElementById('plotBtn')]
        .forEach(el => el.disabled = false);

      iS.innerHTML = '';
      indicators.forEach(ind => iS.append(new Option(ind.name, ind.code)));
      yS.innerHTML = '';
      selectedYears.forEach(y => yS.append(new Option(y, y)));

      fi.oninput = () => {
        const val = fi.value.toLowerCase();
        Array.from(iS.options).forEach(o => o.hidden = !o.text.toLowerCase().includes(val));
      };

      document.getElementById('last5Btn').onclick = () => {
        const rec = selectedYears.slice(-5);
        Array.from(yS.options).forEach(o => o.selected = rec.includes(o.value));
      };
      document.getElementById('last10Btn').onclick = () => {
        const rec = selectedYears.slice(-10);
        Array.from(yS.options).forEach(o => o.selected = rec.includes(o.value));
      };

      document.getElementById('plotBtn').onclick = () => {
        const selI = Array.from(iS.selectedOptions).map(o => o.value);
        const selY = Array.from(yS.selectedOptions).map(o => o.value);
        if (!selI.length || !selY.length) return alert('V√¶lg mindst √©n indikator og √©t √•r.');

        const datasets = selI.map(code => ({
          label: indicators.find(i => i.code === code).name,
          data: selY.map(y => latest1.dataMap[code] ? latest1.dataMap[code][y] : null),
          fill: false,
          borderWidth: 2
        }));

        if (graphChart) graphChart.destroy();
        const ctx = document.getElementById('chart').getContext('2d');
        graphChart = new Chart(ctx, {
          type: 'line',
          data: { labels: selY, datasets },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: false } },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) { label += ': '; }
                    if (context.parsed.y !== null) { label += context.parsed.y.toFixed(2); }
                    return label;
                  }
                }
              }
            }
          }
        });
      };
    };

    function onGraphsClick() {
        if (!latest1) return alert('Hent data f√∏rst');
        document.getElementById('graphSection').style.display = 'block';
        document.getElementById('giniSection').style.display = 'none';
        populateGraphControls();
    };
// *** START: NYE FUNKTIONER TIL GLOBAL UDFORSKER (v2) ***

    // Denne liste definerer de 14 n√∏gletal, du bad om
    const relevantIndicatorCodes = [
      'NY.GDP.PCAP.KD', 'NY.GDP.PCAP.PP.KD', 'SI.POV.GINI', 'SP.DYN.LE00.IN',
      'SP.DYN.TFRT.IN', 'SP.DYN.CBRT.IN', 'SP.DYN.CDRT.IN', 'SH.MED.PHYS.ZS',
      'SH.MED.BEDS.ZS', 'SE.COM.DURS', 'SH.STA.BRTC.ZS', 'EN.GHG.CO2.ZG.AR5',
      'EG.ELC.ACCS.ZS', 'SH.H2O.SMDW.ZS'
    ];
    
    // Globals til at styre de nye grafer
    

    // 1. Fyld dropdown-menuen (U√ÜNDRET)
    function populateExplorerDropdown() {
      const select = document.getElementById('explorerIndicatorSelect');
      const relevantIndicators = indicators.filter(ind => 
        relevantIndicatorCodes.includes(ind.code)
      );
      relevantIndicators.sort((a, b) => a.name.localeCompare(b.name));
      
      select.innerHTML = '';
      select.append(new Option('‚Äì V√¶lg et n√∏gletal ‚Äì', ''));
      relevantIndicators.forEach(ind => {
        select.append(new Option(ind.name, ind.code));
      });
    }

    // 2. "Find nyeste v√¶rdi"-funktionen (U√ÜNDRET)
    function findLatestValue(countryCode, indicatorCode) {
      const indicatorData = worldBankData.data[countryCode]?.[indicatorCode];
      if (!indicatorData) {
        return null;
      }
      const availableYears = Object.keys(indicatorData);
      availableYears.sort((a, b) => b - a); 
      for (const year of availableYears) {
        if (indicatorData[year] != null) {
          return { value: indicatorData[year], year: year };
        }
      }
      return null;
    }

    // 3. Hovedfunktionen der k√∏rer analysen (OPDATERET v3 - Sortering rettet)
    function runGlobalAnalysis() {
      const indicatorCode = document.getElementById('explorerIndicatorSelect').value;
      if (!indicatorCode) {
        alert('V√¶lg venligst et n√∏gletal.');
        return;
      }
      
      const indicatorName = worldBankData.metadata.indicators[indicatorCode];
      
      let allCountryData = [];
      let totalSum = 0;
      
      for (const countryCode in worldBankData.metadata.countries) {
        const latest = findLatestValue(countryCode, indicatorCode);
        
        if (latest) {
          // *** √ÖRET TILF√òJES NU DIREKTE TIL NAVNET ***
          allCountryData.push({
            name: `${worldBankData.metadata.countries[countryCode]} (${latest.year})`,
            value: latest.value
          });
          totalSum += latest.value;
        }
      }

      if (allCountryData.length === 0) {
        document.getElementById('explorerSnapshot').textContent = 
          `Ingen data fundet for "${indicatorName}".`;
        return;
      }

      // Beregn og vis "Snapshot"
      const average = totalSum / allCountryData.length;
      document.getElementById('explorerSnapshot').innerHTML = `
        Baseret p√• ${allCountryData.length} lande: <br>
        <strong>Globalt gennemsnit for "${indicatorName}": ${average.toFixed(2)}</strong>
      `;

      // Sorter listen fra h√∏jest til lavest
      allCountryData.sort((a, b) => b.value - a.value);

      // Udv√¶lg Top 10 og Bund 10
      const top10 = allCountryData.slice(0, 10);
      const bund10 = allCountryData.slice(-10);

      // *** START: RETTELSE AF SORTERING ***
      drawExplorerChart(
        'explorerChartTop10',
        explorerChartTop10Instance,
        top10, // Fjernet .reverse(). Nu plottes den h√∏jeste v√¶rdi √∏verst.
        'Top 10 H√∏jeste V√¶rdier',
        'rgba(75, 192, 192, 0.6)' // Gr√∏nlig farve
      );
      
      drawExplorerChart(
        'explorerChartBottom10',
        explorerChartBottom10Instance,
        bund10.reverse(), // Tilf√∏jet .reverse(). Nu plottes den laveste v√¶rdi √∏verst.
        'Bund 10 Laveste V√¶rdier',
        'rgba(255, 99, 132, 0.6)' // R√∏dlig farve
      );
      // *** SLUT: RETTELSE AF SORTERING ***
    }

    // 4. NY genanvendelig funktion til at tegne BEGGE grafer
    function drawExplorerChart(canvasId, chartInstance, data, title, color) {
      if (chartInstance) {
        chartInstance.destroy(); // Ryd den gamle graf
      }

      const ctx = document.getElementById(canvasId).getContext('2d');
      
      // Vi gemmer instansen i en global variabel, s√• vi kan rydde den
      const newChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          // 'data' er vores array af {name, value} objekter
          datasets: [{
            data: data, 
            backgroundColor: color,
            // Fort√¶l Chart.js hvordan den skal l√¶se vores objekter
            parsing: {
              xAxisKey: 'value', // V√¶rdien skal p√• X-aksen
              yAxisKey: 'name'   // Navnet (med √•r) skal p√• Y-aksen
            }
          }]
        },
        options: {
          indexAxis: 'y', // <-- G√∏r grafen horisontal
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            // Tilf√∏j titel (Top 10 / Bund 10)
            title: {
              display: true,
              text: title
            },
            legend: {
              display: false // Skjul "label"
            },
            // Tooltip viser nu "Land (√Ör): V√¶rdi"
            tooltip: {
              callbacks: {
                label: function(context) {
                  // context.label har nu "Land (√Ör)"
                  // context.parsed.x har v√¶rdien
                  return `${context.label}: ${context.parsed.x.toFixed(2)}`;
                }
              }
            }
          }
        }
      });
      
      // Opdater den globale instans-variabel
      if (canvasId === 'explorerChartTop10') {
        explorerChartTop10Instance = newChartInstance;
      } else {
        explorerChartBottom10Instance = newChartInstance;
      }
    }
    // *** SLUT: NYE FUNKTIONER TIL GLOBAL UDFORSKER (v2) ***
// *** START: NYE FUNKTIONER TIL KORRELATIONS-ANALYSE ***

     // Holder styr p√• grafen

    // 1. Fyld dropdown-menuerne (Lande og Indikatorer)
    function populateCorrelationDropdowns() {
      const cSelect = document.getElementById('correlationCountry');
      const xSelect = document.getElementById('correlationX');
      const ySelect = document.getElementById('correlationY');

      cSelect.innerHTML = '<option value="">‚Äì V√¶lg land ‚Äì</option>';
      xSelect.innerHTML = '<option value="">‚Äì V√¶lg X-akse ‚Äì</option>';
      ySelect.innerHTML = '<option value="">‚Äì V√¶lg Y-akse ‚Äì</option>';

      // Fyld lande (fra global variabel)
      const countries = worldBankData.metadata.countries;
      const sortedCountries = Object.entries(countries)
          .sort(([, nameA], [, nameB]) => nameA.localeCompare(nameB));
      for (const [id, name] of sortedCountries) {
        cSelect.append(new Option(name, id));
      }

      // *** START RETTELSE ***
      // Lav en Kopi af 'indicators' f√∏r sortering, for ikke at √∏del√¶gge den globale liste
      const sortedIndicators = [...indicators].sort((a, b) => a.name.localeCompare(b.name));
      // *** SLUT RETTELSE ***

      // Fyld indikatorer (fra den nye sorterede kopi)
      for (const ind of sortedIndicators) { // <-- Bruger nu 'sortedIndicators'
        xSelect.append(new Option(ind.name, ind.code));
        ySelect.append(new Option(ind.name, ind.code));
      }
    }

    // 2. K√∏r selve analysen
    function runCorrelationAnalysis() {
      // Hent alle valg fra UI
      const countryCode = document.getElementById('correlationCountry').value;
      const xCode = document.getElementById('correlationX').value;
      const yCode = document.getElementById('correlationY').value;
      const yearFrom = parseInt(document.getElementById('correlationYearFrom').value);
      const yearTo = parseInt(document.getElementById('correlationYearTo').value);

      // Validering
      if (!countryCode || !xCode || !yCode) {
        alert("V√¶lg venligst et land, en X-akse og en Y-akse.");
        return;
      }
      if (isNaN(yearFrom) || isNaN(yearTo) || yearFrom > yearTo) {
        alert("Ugyldig √•rr√¶kke.");
        return;
      }

      // 3. Indsaml datapunkter (din id√©)
      const datapoints = [];
      for (let year = yearFrom; year <= yearTo; year++) {
        const yearStr = String(year);
        
        // Find x og y v√¶rdier
        const xVal = worldBankData.data[countryCode]?.[xCode]?.[yearStr];
        const yVal = worldBankData.data[countryCode]?.[yCode]?.[yearStr];

        // VIGTIGT: Kun tilf√∏j, hvis BEGGE v√¶rdier findes for det √•r
        if (xVal != null && yVal != null) {
          datapoints.push({
            x: xVal,
            y: yVal,
            year: yearStr
          });
        }
      }

      if (datapoints.length < 5) { // For f√• punkter til at lave statistik
        alert(`Fandt kun ${datapoints.length} datapunkter. Pr√∏v en l√¶ngere √•rr√¶kke eller andre n√∏gletal.`);
        return;
      }

      // 4. K√∏r matematikken
      const stats = calculateStatistics(datapoints);
      
      // 5. Vis de matematiske resultater
      const statsBox = document.getElementById('correlationStats');
      statsBox.style.display = 'block';
      statsBox.innerHTML = `
        <strong>Forklaringsgrad (R¬≤): ${(stats.rSquared * 100).toFixed(1)}%</strong> 
        <br><small>(${datapoints.length} datapunkter fundet) - ${stats.equation}</small>
      `;

      // 6. Tegn grafen
      drawCorrelationChart(datapoints, stats.trendline, xCode, yCode);
    }

    // 3. Hj√¶lpefunktion til at lave matematikken (Line√¶r Regression)
    function calculateStatistics(points) {
      const n = points.length;
      let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumY2 = 0;

      for (const p of points) {
        sumX += p.x;
        sumY += p.y;
        sumXY += p.x * p.y;
        sumX2 += p.x * p.x;
        sumY2 += p.y * p.y;
      }

      // Beregn R (Korrelationskoefficient)
      const r_numerator = (n * sumXY) - (sumX * sumY);
      const r_denominator = Math.sqrt(((n * sumX2) - (sumX * sumX)) * ((n * sumY2) - (sumY * sumY)));
      const r = r_numerator / r_denominator;
      
      const rSquared = r * r;

      // Beregn trendlinje (y = mx + b)
      const slope = r_numerator / ((n * sumX2) - (sumX * sumX));
      const intercept = (sumY / n) - (slope * (sumX / n));

      // Find start/slut-punkter for trendlinjen
      const minX = Math.min(...points.map(p => p.x));
      const maxX = Math.max(...points.map(p => p.x));

      const trendline = [
        { x: minX, y: (slope * minX) + intercept },
        { x: maxX, y: (slope * maxX) + intercept }
      ];

      return {
        r: r,
        rSquared: rSquared,
        equation: `y = ${slope.toFixed(2)}x + ${intercept.toFixed(2)}`,
        trendline: trendline
      };
    }

    // 4. Funktion til at tegne scatter plot-grafen
    function drawCorrelationChart(points, trendline, xLabel, yLabel) {
      if (correlationChartInstance) {
        correlationChartInstance.destroy();
      }
      
      const xName = worldBankData.metadata.indicators[xLabel] || xLabel;
      const yName = worldBankData.metadata.indicators[yLabel] || yLabel;

      const ctx = document.getElementById('correlationChart').getContext('2d');
      correlationChartInstance = new Chart(ctx, {
        type: 'scatter', // Vigtig: Scatter plot
        data: {
          datasets: [
            {
              label: 'Datapunkter (√Ör)',
              data: points, // Vores (x, y, √•r) objekter
              backgroundColor: 'rgba(75, 192, 192, 0.6)'
            },
            {
              label: 'Trendlinje (R¬≤)',
              data: trendline, // De to (x, y) punkter for linjen
              type: 'line', // Overstyr til at v√¶re en linje
              backgroundColor: 'rgba(255, 99, 132, 0.6)',
              borderColor: 'rgba(255, 99, 132, 1)',
              fill: false,
              pointRadius: 0 // Skjul punkterne p√• selve linjen
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: { display: true, text: xName }
            },
            y: {
              title: { display: true, text: yName }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  // Vores 'points' er i det f√∏rste dataset
                  if (context.datasetIndex === 0) {
                    const p = context.raw;
                    return `√Ör: ${p.year} (X: ${p.x.toFixed(2)}, Y: ${p.y.toFixed(2)})`;
                  }
                  return "Trendlinje"; // Tooltip for trendlinjen
                }
              }
            }
          }
        }
      });
    }
    // *** SLUT: NYE FUNKTIONER TIL KORRELATIONS-ANALYSE ***
    // START: GINI-SIMULATOR KODE (HELT U√ÜNDRET)
    let lorenzActualChart, lorenzSimChart;

    function showGiniSection() {
        if (!latest1) {
            alert('Hent data for et land f√∏rst.');
            return;
        }
        document.getElementById('giniSection').style.display = 'block';
        document.getElementById('graphSection').style.display = 'none';

        const countryName = document.getElementById('country1').options[document.getElementById('country1').selectedIndex].text;
        const introText = document.getElementById('giniIntroText');

        const findLatestValue = (indicatorData) => {
            if (!indicatorData) return { value: null, year: null };
            const years = Object.keys(indicatorData).sort().reverse();
            for (const year of years) {
                if (indicatorData[year] !== null && indicatorData[year] > 0) {
                    return { value: indicatorData[year], year };
                }
            }
            return { value: null, year: null };
        };

        const giniData = findLatestValue(latest1.dataMap['SI.POV.GINI']);
        initialCountryGiniData = giniData;

        const bottom10 = findLatestValue(latest1.dataMap['SI.DST.FRST.10']);
        const bottom20 = findLatestValue(latest1.dataMap['SI.DST.FRST.20']);
        const top20 = findLatestValue(latest1.dataMap['SI.DST.05TH.20']);
        const top10 = findLatestValue(latest1.dataMap['SI.DST.10TH.10']);

        if (giniData.value !== null) {
            let text = `Senest m√•lte Gini-koefficient for ${countryName} er ${giniData.value.toFixed(2)} (${giniData.year}). `;
            text += (bottom10.value && bottom20.value && top10.value && top20.value)
                ? `Lorenz-kurven er baseret p√• detaljerede indkomstfordelingsdata.`
                : `Detaljerede indkomstfordelingsdata mangler, s√• Lorenz-kurven er en approksimation baseret p√• Gini-koefficienten.`;
            introText.textContent = text;
            plotActualLorenz(giniData.value, bottom10.value, bottom20.value, top10.value, top20.value);
        } else {
            introText.textContent = `Der er ingen tilg√¶ngelige Gini-data for ${countryName}. Simulatoren nedenfor bruger en generisk model.`;
            if (lorenzActualChart) lorenzActualChart.destroy();
        }

        resetSimulation(initialCountryGiniData);
    }

    function plotActualLorenz(gini, bottom10, bottom20, top10, top20) {
      if (lorenzActualChart) lorenzActualChart.destroy();
      const ctx = document.getElementById('lorenzChartActual').getContext('2d');
      let lorenzData;

      if (bottom10 != null && bottom20 != null && top10 != null && top20 != null) {
          const interpolate = (p_target, p1, l1, p2, l2) => l1 + ((l2 - l1) / (p2 - p1)) * (p_target - p1);
          lorenzData = [0, bottom10, bottom20];
          for(let p = 30; p <= 70; p += 10) {
              lorenzData.push(interpolate(p, 20, bottom20, 80, 100 - top20));
          }
          lorenzData.push(100 - top20, 100 - top10, 100);
      } else {
          lorenzData = calculateLorenzFromGini(gini);
      }

      lorenzActualChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: Array.from({ length: 11 }, (_, i) => i * 10),
          datasets: [
            { label: 'Perfekt lighed', data: Array.from({ length: 11 }, (_, i) => i * 10), borderColor: 'grey', borderDash: [5, 5], pointRadius: 0, fill: false },
            { label: 'Faktisk Lorenz-kurve', data: lorenzData, borderColor: 'blue', backgroundColor: 'rgba(0, 0, 255, 0.1)', fill: 0, tension: 0.4 }
          ]
        },
        options: chartOptions('Faktisk indkomstfordeling', 'Kumulativ % af befolkning', 'Kumulativ % af indkomst')
      });
    }

    function plotSimulationLorenz(giniValue) {
        if (lorenzSimChart) lorenzSimChart.destroy();
        const ctx = document.getElementById('lorenzChartSimulation').getContext('2d');
        
        const lorenzData = calculateLorenzFromGini(giniValue);

        lorenzSimChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({ length: 11 }, (_, i) => i * 10),
                datasets: [
                    { label: 'Perfekt lighed', data: Array.from({ length: 11 }, (_, i) => i * 10), borderColor: 'grey', borderDash: [5, 5], pointRadius: 0, fill: false },
                    { label: `Simuleret Lorenz-kurve (Gini: ${(giniValue / 100).toFixed(2)})`, data: lorenzData, borderColor: 'red', backgroundColor: 'rgba(255, 0, 0, 0.1)', fill: 0, tension: 0.4 }
                ]
            },
            options: chartOptions('Simuleret indkomstfordeling', 'Kumulativ % af befolkning', 'Kumulativ % af indkomst')
        });
    }

    const scenarios = {
        mikrolaan: { feedback: "Mikrol√•n styrker sm√• iv√¶rks√¶ttere blandt de fattigste. Dette l√∏fter bunden af indkomstfordelingen og mindsker uligheden.", giniModifier: -3.0 },
        uddannelse: { feedback: "Bedre uddannelse giver adgang til jobs med h√∏jere l√∏n, hvilket is√¶r gavner den lavere middelklasse og reducerer uligheden.", giniModifier: -4.0 },
        fairtrade: { feedback: "Fairtrade-aftaler sikrer en mere retf√¶rdig pris for landbrugsvarer. Det √∏ger indkomsten for mange sm√•b√∏nder og mindsker uligheden.", giniModifier: -3.5 },
        demokrati: { feedback: "St√¶rkere demokrati f√∏rer ofte til love, der styrker arbejdstagerrettigheder og sociale sikkerhedsnet, hvilket mindsker uligheden.", giniModifier: -5.0 },
        mereBistand: { feedback: "Velanvendt ulandsbistand i f.eks. sundhed og fattigdomsbek√¶mpelse kan give et direkte l√∏ft til de fattigste og reducere uligheden.", giniModifier: -4.5 },
        offentligInvest: { feedback: "Offentlige investeringer i infrastruktur og uddannelse skaber jobs for en bred del af befolkningen og styrker middelklassen.", giniModifier: -4.0 },
        landgrabbing: { feedback: "N√•r sm√•b√∏nder mister deres jord, falder de i fattigdom, mens profitten tilfalder en lille elite. Dette √∏ger uligheden markant.", giniModifier: +5.0 },
        korruption: { feedback: "Korruption omdirigerer midler, der skulle have hjulpet samfundet, til en lille elite. De rigeste bliver markant rigere, og uligheden vokser.", giniModifier: +7.0 },
        fdi: { feedback: "Udenlandske investeringer skaber nye jobs, men gavner ofte fagl√¶rt arbejdskraft og kapitalejere mest. Dette kan √∏ge indkomstforskellene.", giniModifier: +3.0 },
        mindreBistand: { feedback: "Mindre ulandsbistand kan betyde nedsk√¶ringer i sociale programmer, der st√∏tter de fattigste, hvilket √∏ger uligheden.", giniModifier: +4.0 },
    };

    function resetSimulation(initialGiniData) {
        const giniToUse = initialGiniData && initialGiniData.value ? initialGiniData.value : 47; // Default til 47 hvis ingen data
        plotSimulationLorenz(giniToUse);
        document.getElementById('scenarioFeedback').textContent = "V√¶lg et scenarie for at se, hvordan det p√•virker indkomstfordelingen.";
    }

    document.getElementById('simulationControls').addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            const scenarioKey = e.target.dataset.scenario;
            if (scenarioKey === 'reset') {
                resetSimulation(initialCountryGiniData);
            } else if (scenarios[scenarioKey]) {
                const scenario = scenarios[scenarioKey];
                const initialGini = (initialCountryGiniData && initialCountryGiniData.value) ? initialCountryGiniData.value : 47;
                let newGini = initialGini + scenario.giniModifier;
                newGini = Math.max(0, Math.min(100, newGini));
                plotSimulationLorenz(newGini);
                document.getElementById('scenarioFeedback').textContent = scenario.feedback;
            }
        }
    });

    function calculateLorenzFromGini(giniRaw) {
        const gini = giniRaw / 100;
        const points = 11;
        const lorenz = [];
        for (let i = 0; i < points; i++) {
            const p = i / (points - 1);
            if (p === 0) { lorenz.push(0); continue; }
            const exponent = (1 + gini) / (1 - gini);
            lorenz.push(Math.pow(p, exponent) * 100);
        }
        return lorenz;
    }

    function chartOptions(title, xLabel, yLabel) {
      return {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          title: { display: true, text: title },
          legend: { position: 'bottom' }
        },
        scales: {
          x: {
            title: { display: true, text: xLabel },
            ticks: { callback: function(value) { return this.getLabelForValue(value) + '%'; } }
          },
          y: {
            title: { display: true, text: yLabel },
            min: 0,
            max: 100,
            ticks: { callback: value => value + '%' }
          }
        }
      };
    }

    const controlsDiv = document.querySelector('.controls');
    const giniButton = document.createElement('button');
    giniButton.id = 'btnGini';
    giniButton.textContent = 'Analyser ulighed';
    controlsDiv.insertBefore(giniButton, document.getElementById('btnGraphs').nextSibling);
    // (Den oprindelige .onclick-handler for Gini er allerede sat ovenfor)

    // SLUT: GINI-SIMULATOR KODE
  </script>
</body>
</html>

