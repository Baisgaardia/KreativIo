<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>World Bank Data & Sammenligning & Grafer</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    .controls, #graphControls { display: flex; gap: .5em; flex-wrap: wrap; align-items: center; margin-bottom: 1rem; }
    select, button, input[type="text"] { font-size: 1rem; padding: .5em; }
    .table-container { overflow-x: auto; }
    table { border-collapse: collapse; width: max-content; min-width: 100%; margin-top: 1rem; }
    th, td { border: 1px solid #ddd; padding: .5em; text-align: center; white-space: nowrap; }
    th { background: #f2f2f2; }
    tr:nth-child(even) { background: #fafafa; }
    canvas#chart { max-width: 700px; max-height: 400px; width: 100%; height: auto; margin-top: 1rem; }
    /* Modal styling */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
    .modal-content { background: #fff; margin: 5% auto; padding: 1rem; border-radius: 4px; width: 80%; max-width: 600px; max-height: 80%; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; }
    .modal-body { margin-top: 1rem; columns: 3; column-gap: 1rem; }
    .modal-body label { display: block; margin-bottom: .25em; }
    .modal-footer { margin-top: 1em; text-align: right; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <h1>World Bank Data & Sammenligning & Grafer</h1>

  <div class="controls">
    <label>Land 1:
      <select id="country1"><option value="" disabled selected>‚Äì v√¶lg land ‚Äì</option></select>
    </label>
    <label>Land 2 (valgfri):
      <select id="country2"><option value="" disabled selected>‚Äì v√¶lg land ‚Äì</option></select>
    </label>
    <button id="openYearModal" type="button">V√¶lg √•r</button>
    <button id="btnFetch">Hent data</button>
    <button id="btnExcel" disabled>Download Excel (Land 1)</button>
    <button id="btnGraphs">Lav grafer</button>
  </div>

  <div id="tableContainer" class="table-container"></div>

  <div id="graphSection" style="display: none;">
    <h2>Graf-v√¶rkt√∏j (Land 1)</h2>
    <div id="graphControls">
      <input type="text" id="filterInput" placeholder="S√∏g indikator‚Ä¶" disabled />
      <select id="indicatorSelect" multiple size="8" disabled></select>
      <select id="yearSelect" multiple size="6" disabled></select>
      <button id="last5Btn" disabled>Seneste 5 √•r</button>
      <button id="last10Btn" disabled>Seneste 10 √•r</button>
      <button id="plotBtn" disabled>Tegn graf</button>
    </div>
    <canvas id="chart"></canvas>
  </div>

  <div id="giniSection" style="display: none; margin-top: 2rem; max-width: 700px;">
    <h2>Analyse af Indkomstulighed (Land 1)</h2>

    <div id="giniActualData">
      <p id="giniIntroText">Henter Gini-data...</p>
      <canvas id="lorenzChartActual" height="200"></canvas>
    </div>

    <div id="giniSimulation" style="margin-top: 2rem; border-top: 2px solid #eee; padding-top: 1rem;">
      <h3>Sandkasse: Test udviklingsscenarier</h3>
      <p>Hvordan ville f√∏lgende h√¶ndelser p√•virke uligheden i et land som det valgte? (modellen er generisk)</p>
      <div id="simulationControls" style="display: flex; flex-wrap: wrap; gap: 0.5em; margin-bottom: 1rem;">
    <button data-scenario="mikrolaan">Succes med mikrol√•n üìà</button>
    <button data-scenario="uddannelse">Investering i grunduddannelse üßë‚Äçüè´</button>
    <button data-scenario="fairtrade">Fairtrade-aftale for b√∏nder ‚òï</button>
    <button data-scenario="landgrabbing" style="background-color: #fee;">Opk√∏b af landbrugsjord üìâ</button>
    <button data-scenario="korruption" style="background-color: #fee;">Korruption med ulandsbistand üí∞</button>

    <button data-scenario="fdi">Flere udenlandske investeringer (FDI) üè≠</button>
    <button data-scenario="demokrati">Mere demokratisk lovgivning üó≥Ô∏è</button>
    <button data-scenario="mereBistand">Mere ulandsbistand (effektiv) üí∏</button>
    <button data-scenario="mindreBistand" style="background-color: #fee;">Mindre ulandsbistand üíî</button>
    <button data-scenario="offentligInvest">Flere offentlige investeringer üèóÔ∏è</button>

    <button data-scenario="reset">Nulstil model</button>
</div>
      <canvas id="lorenzChartSimulation" height="200"></canvas>
      <p id="scenarioFeedback" style="min-height: 4em; background-color: #f8f8f8; padding: 0.5em; border-radius: 4px;"></p>
    </div>
  </div>
  <div id="yearModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>V√¶lg √Ör</h3>
        <button id="closeYearModal" style="font-size:1.2rem;">‚úñ</button>
      </div>
      <div>
        <button id="selectAllYears" type="button">V√¶lg alle</button>
        <button id="clearAllYears" type="button">Frav√¶lg alle</button>
        <input type="text" id="yearSearch" placeholder="S√∏g √•r‚Ä¶" style="margin-left:1rem; padding:.3em; width:150px;" />
      </div>
      <div class="modal-body" id="yearList"></div>
      <div class="modal-footer">
        <button id="applyYears" type="button">OK</button>
      </div>
    </div>
  </div>

  <footer style="display:flex; justify-content:space-between; font-size:0.8em; margin:2rem 0 0 0;">
    <div class="left-footer" style="text-align:left;">
      The World Bank. (2025). World Development Indicators. Hentet 25. maj 2025 fra https://api.worldbank.org/v2/country/{land}/indicator/{indikator}?format=json
    </div>
    <div class="right-footer" style="text-align:right;">
      &copy; Allan Baisgaard, Aalborg Handelsgymnasie, Tur√∏gade
    </div>
  </footer>

  <script>
    // Konfiguration
    const proxyUrl = '';
    const apiBase  = 'https://api.worldbank.org/v2/country/';
    const params   = '?format=json&per_page=1000';

    // Indikatorer
    const indicators = [
      { code: 'AG.LND.TOTL.K2',    name: 'Areal (kvadratkilometer)' },
      { code: 'SP.POP.GROW',        name: 'Befolkningstilv√¶ksten (√•rlig %)' },
      { code: 'SP.URB.TOTL.IN.ZS',  name: 'Urban befolkning (% af befolkningen)' },
      { code: 'SP.URB.GROW',        name: 'Urban befolkningsv√¶kst (√•rlig %)' },
      { code: 'NY.GDP.MKTP.KD.ZG',  name: 'BNP-v√¶kst (√•rlig %)' },
      { code: 'NY.GDP.PCAP.KD',     name: 'BNP per indbygger (konstant 2015 US$)' },
      { code: 'NY.GDP.PCAP.PP.KD',  name: 'BNP per indbygger, PPP (konstant 2021 $)' },
      { code: 'NY.GDP.PCAP.KD.ZG',  name: 'BNP per indbygger v√¶kst (√•rlig %)' },
      { code: 'NE.GDI.FTOT.ZS',     name: 'Offentlige investeringer i % af BNP' },
      { code: 'FP.CPI.TOTL.ZG',     name: 'Inflation, forbrugerpriser (√•rlig %)' },
      { code: 'SL.UEM.TOTL.ZS',     name: 'Arbejdsl√∏shed, samlet (% af arbejdskraft)' },
      { code: 'SI.POV.GINI',        name: 'Gini-indeks' },
      { code: 'SI.DST.10TH.10',     name: 'Indkomstandel √∏verste 10%' },
      { code: 'SI.DST.05TH.20',     name: 'Indkomstandel √∏verste 20%' },
      { code: 'SI.DST.FRST.10',     name: 'Indkomstandel nederste 10%' },
      { code: 'SI.DST.FRST.20',     name: 'Indkomstandel nederste 20%' },
      { code: 'SP.DYN.LE00.IN',     name: 'Forventet levealder ved f√∏dslen, samlet (√•r)' },
      { code: 'SP.DYN.LE00.MA.IN',  name: 'Forventet levealder ved f√∏dslen, m√¶nd (√•r)' },
      { code: 'SP.DYN.LE00.FE.IN',  name: 'Forventet levealder ved f√∏dslen, kvinder (√•r)' },
      { code: 'SP.DYN.CBRT.IN',     name: 'F√∏dselsraten i promille' },
      { code: 'SP.DYN.CDRT.IN',     name: 'D√∏draten i promille' },
      { code: 'SP.DYN.IMRT.IN',     name: 'Sp√¶db√∏rnsd√∏delighed (pr. 1.000)' },
      { code: 'SH.DYN.MORT',        name: 'D√∏delighed under 5 √•r (pr. 1.000)' },
      { code: 'SP.DYN.TFRT.IN',     name: 'Fertilitetsraten (f√∏dsler/kvinde)' },
      { code: 'SL.AGR.EMPL.ZS',     name: 'Antal besk√¶ftigede i prim√¶re erhverv' },
      { code: 'NV.AGR.TOTL.ZS',     name: 'Prim√¶re erhvervs v√¶rditilv√¶kst (% af BNP)' },
      { code: 'SL.IND.EMPL.ZS',     name: 'Antal besk√¶ftigede i det sekund√¶re erhverv' },
      { code: 'NV.IND.TOTL.ZS',     name: 'Sekund√¶r erhvervs v√¶rditilv√¶kst (% af BNP)' },
      { code: 'SL.SRV.EMPL.ZS',     name: 'Antal besk√¶ftigede i det terti√¶re erhverv' },
      { code: 'NV.SRV.TOTL.ZS',     name: 'Terti√¶re erhvervs v√¶rditilv√¶kst (% af BNP)' },
      { code: 'SH.MED.PHYS.ZS',     name: 'L√¶ger (pr. 1.000 indb.)' },
      { code: 'SH.MED.BEDS.ZS',     name: 'Hospitalssenge (pr. 1.000 indb.)' },
      { code: 'SE.COM.DURS',        name: 'Varighed obligatorisk uddannelse (√•r)' },
      { code: 'SH.STA.BRTC.ZS',     name: 'F√∏dsler assisteret af sundhedspersonale (%)' },
      { code: 'EN.GHG.CO2.ZG.AR5',  name: 'CO‚ÇÇ-udledning (% √¶ndring fra 1990)' },
      { code: 'IT.NET.BBND.P2',     name: 'Bredb√•ndsabonnementer (pr. 100 pers.)' },
      { code: 'IT.MLT.MAIN.P2',     name: 'Fastnettelefonabonn. (pr. 100 pers.)' },
      { code: 'IT.CEL.SETS.P2',     name: 'Mobilabonnementer (pr. 100 pers.)' },
      { code: 'EG.ELC.ACCS.ZS',     name: 'Adgang til elektricitet (%)' },
      { code: 'EG.ELC.ACCS.RU.ZS',  name: 'Adgang til elektricitet, landdistrikter (%)' },
      { code: 'EG.ELC.ACCS.UR.ZS',  name: 'Adgang til elektricitet, byer (%)' },
      { code: 'SH.H2O.BASW.ZS',     name: 'Grundl√¶ggende drikkevandsservice (%)' },
      { code: 'SH.H2O.SMDW.ZS',     name: 'Sikkert forvaltet drikkevand (%)' },
      { code: 'SH.H2O.SMDW.RU.ZS',  name: 'Sikkert forvaltet drikkevand, landdistr. (%)' },
      { code: 'SH.H2O.SMDW.UR.ZS',  name: 'Sikkert forvaltet drikkevand, byer (%)' }
    ];

    // Globale variabler
    let years = [];
    for (let y = 1960; y <= 2024; y++) years.push(String(y));
    let selectedYears = [...years];
    let latest1, latest2, graphChart;
    let initialCountryGiniData = null;

    document.addEventListener('DOMContentLoaded', () => {
      populateCountryDropdowns();
      initializeYearModal();

    document.getElementById('btnFetch').onclick = () => {
      const c1 = document.getElementById('country1').value;
      const c2 = document.getElementById('country2').value;
      if (!c1) return alert('V√¶lg venligst mindst √©t land.');

      document.getElementById('tableContainer').innerHTML = 'Henter data...';
      const c1Name = document.getElementById('country1').options[document.getElementById('country1').selectedIndex].text;
      const c2Name = c2 ? document.getElementById('country2').options[document.getElementById('country2').selectedIndex].text : '';

      if (c2) {
        Promise.all([fetchRaw(c1), fetchRaw(c2)]).then(([p1, p2]) => {
          latest1 = p1; latest2 = p2;
          const yearsUnion = [...new Set([...p1.years, ...p2.years])].sort();
          p1.years = yearsUnion; p2.years = yearsUnion;
          document.getElementById('tableContainer').innerHTML = '';
          document.getElementById('tableContainer').append(buildComparison(p1, p2, c1Name, c2Name));
          document.getElementById('btnExcel').disabled = false;
        });
      } else {
        fetchRaw(c1).then(p => {
          latest1 = p; latest2 = null;
          document.getElementById('tableContainer').innerHTML = '';
          document.getElementById('tableContainer').append(buildTable(p));
          document.getElementById('btnExcel').disabled = false;
        });
      }
    };

    function populateCountryDropdowns() {
      fetch(apiBase + 'all?format=json&per_page=300')
        .then(r => r.json())
        .then(json => {
          const list = json[1].filter(c => c.region.value !== 'Aggregates');
          list.forEach(c => {
            document.getElementById('country1').append(new Option(c.name, c.id));
            document.getElementById('country2').append(new Option(c.name, c.id));
          });
        });
    }

    function initializeYearModal() {
      const modal = document.getElementById('yearModal');
      const list = document.getElementById('yearList');
      const search = document.getElementById('yearSearch');

      function renderList(filter = '') {
        list.innerHTML = '';
        years.filter(y => y.includes(filter)).forEach(y => {
          const lbl = document.createElement('label');
          const cb = document.createElement('input'); cb.type = 'checkbox'; cb.value = y;
          cb.checked = selectedYears.includes(y);
          lbl.append(cb, ' ', y);
          list.append(lbl);
        });
      }
      renderList();

      document.getElementById('openYearModal').onclick = () => { modal.style.display = 'block'; search.value=''; renderList(); };
      document.getElementById('closeYearModal').onclick = () => modal.style.display = 'none';
      document.getElementById('selectAllYears').onclick = () => { selectedYears = [...years]; renderList(search.value); };
      document.getElementById('clearAllYears').onclick = () => { selectedYears = []; renderList(search.value); };
      search.oninput = () => renderList(search.value);
      document.getElementById('applyYears').onclick = () => {
        selectedYears = Array.from(list.querySelectorAll('input[type=\"checkbox\"]:checked')).map(cb => cb.value);
        modal.style.display = 'none';
      };
      window.onclick = e => { if (e.target === modal) modal.style.display = 'none'; };
    }

    async function fetchRaw(country) {
      const dataMap = {};
      indicators.forEach(ind => { dataMap[ind.code] = {}; selectedYears.forEach(y => dataMap[ind.code][y] = null); });
      await Promise.all(indicators.map(ind =>
        fetch(apiBase + country + '/indicator/' + ind.code + params)
          .then(r => r.json())
          .then(json => json[1] && json[1].forEach(o => {
            if (selectedYears.includes(o.date)) dataMap[ind.code][o.date] = +o.value;
          }))
      ));
      return { years: selectedYears, dataMap };
    }

    function buildTable(p) {
      const tbl = document.createElement('table');
      const yearsToShow = p.years && p.years.length ? p.years : selectedYears;
      const head = tbl.createTHead().insertRow();
      head.insertCell().textContent = 'N√∏gletal \\ √Ör';
      yearsToShow.forEach(y => head.insertCell().textContent = y);
      const body = tbl.createTBody();
      indicators.forEach(ind => {
        const row = body.insertRow(); row.insertCell().textContent = ind.name;
        yearsToShow.forEach(y => {
          const v = p.dataMap[ind.code] ? p.dataMap[ind.code][y] : null;
          row.insertCell().textContent = v != null ? v.toFixed(2) : '‚Äì';
        });
      });
      return tbl;
    }

    function buildComparison(p1, p2, c1, c2) {
      const tbl = document.createElement('table');
      const head = tbl.createTHead();
      const r1 = head.insertRow(); r1.insertCell().rowSpan=2; r1.cells[0].textContent='N√∏gletal \\ √Ör';
      p1.years.forEach(y=>{ const c=r1.insertCell(); c.colSpan=2; c.textContent=y; });
      const r2 = head.insertRow(); p1.years.forEach(_=>{ r2.insertCell().textContent=c1; r2.insertCell().textContent=c2; });
      const body = tbl.createTBody();
      indicators.forEach(ind=>{
        const row = body.insertRow(); row.insertCell().textContent=ind.name;
        p1.years.forEach(y=>{
          const v1 = p1.dataMap[ind.code][y], v2 = p2.dataMap[ind.code][y];
          row.insertCell().textContent = v1!=null? v1.toFixed(2):'‚Äì';
          row.insertCell().textContent = v2!=null? v2.toFixed(2):'‚Äì';
        });
      });
      return tbl;
    }

    function downloadExcel() {
      const aoa = [['N√∏gletal \\ √Ör', ...latest1.years]];
      indicators.forEach(ind=>{
        const row=[ind.name]; latest1.years.forEach(y=>{ const v=latest1.dataMap[ind.code][y]; row.push(v!=null?+v.toFixed(2):null); });
        aoa.push(row);
      });
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(aoa);
      XLSX.utils.book_append_sheet(wb, ws, 'Data');
      XLSX.writeFile(wb, `WorldBank_${document.getElementById('country1').value}.xlsx`);
    }

    function populateGraphControls() {
      const fi  = document.getElementById('filterInput');
      const iS  = document.getElementById('indicatorSelect');
      const yS  = document.getElementById('yearSelect');
      [fi, iS, yS,
       document.getElementById('last5Btn'),
       document.getElementById('last10Btn'),
       document.getElementById('plotBtn')]
        .forEach(el => el.disabled = false);

      iS.innerHTML = '';
      indicators.forEach(ind => iS.append(new Option(ind.name, ind.code)));
      yS.innerHTML = '';
      selectedYears.forEach(y => yS.append(new Option(y, y)));

      fi.oninput = () => {
        const val = fi.value.toLowerCase();
        Array.from(iS.options).forEach(o => o.hidden = !o.text.toLowerCase().includes(val));
      };

      document.getElementById('last5Btn').onclick = () => {
        const rec = selectedYears.slice(-5);
        Array.from(yS.options).forEach(o => o.selected = rec.includes(o.value));
      };
      document.getElementById('last10Btn').onclick = () => {
        const rec = selectedYears.slice(-10);
        Array.from(yS.options).forEach(o => o.selected = rec.includes(o.value));
      };

      document.getElementById('plotBtn').onclick = () => {
        const selI = Array.from(iS.selectedOptions).map(o => o.value);
        const selY = Array.from(yS.selectedOptions).map(o => o.value);
        if (!selI.length || !selY.length) return alert('V√¶lg mindst √©n indikator og √©t √•r.');

        const datasets = selI.map(code => ({
          label: indicators.find(i => i.code === code).name,
          data: selY.map(y => latest1.dataMap[code] ? latest1.dataMap[code][y] : null),
          fill: false,
          borderWidth: 2
        }));

        if (graphChart) graphChart.destroy();
        const ctx = document.getElementById('chart').getContext('2d');
        graphChart = new Chart(ctx, {
          type: 'line',
          data: { labels: selY, datasets },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: false } },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) { label += ': '; }
                    if (context.parsed.y !== null) { label += context.parsed.y.toFixed(2); }
                    return label;
                  }
                }
              }
            }
          }
        });
      };
    };

    document.getElementById('btnExcel').onclick = () => {
        if (!latest1) return alert('Ingen data at downloade');
        downloadExcel();
    };

    document.getElementById('btnGraphs').onclick = () => {
        if (!latest1) return alert('Hent data f√∏rst');
        document.getElementById('graphSection').style.display = 'block';
        document.getElementById('giniSection').style.display = 'none';
        populateGraphControls();
    };
    });

    // START: GINI-SIMULATOR KODE
    let lorenzActualChart, lorenzSimChart;

    function showGiniSection() {
        if (!latest1) {
            alert('Hent data for et land f√∏rst.');
            return;
        }
        document.getElementById('giniSection').style.display = 'block';
        document.getElementById('graphSection').style.display = 'none';

        const countryName = document.getElementById('country1').options[document.getElementById('country1').selectedIndex].text;
        const introText = document.getElementById('giniIntroText');

        const findLatestValue = (indicatorData) => {
            if (!indicatorData) return { value: null, year: null };
            const years = Object.keys(indicatorData).sort().reverse();
            for (const year of years) {
                if (indicatorData[year] !== null && indicatorData[year] > 0) {
                    return { value: indicatorData[year], year };
                }
            }
            return { value: null, year: null };
        };

        const giniData = findLatestValue(latest1.dataMap['SI.POV.GINI']);
        initialCountryGiniData = giniData;

        const bottom10 = findLatestValue(latest1.dataMap['SI.DST.FRST.10']);
        const bottom20 = findLatestValue(latest1.dataMap['SI.DST.FRST.20']);
        const top20 = findLatestValue(latest1.dataMap['SI.DST.05TH.20']);
        const top10 = findLatestValue(latest1.dataMap['SI.DST.10TH.10']);

        if (giniData.value !== null) {
            let text = `Senest m√•lte Gini-koefficient for ${countryName} er ${giniData.value.toFixed(2)} (${giniData.year}). `;
            text += (bottom10.value && bottom20.value && top10.value && top20.value)
                ? `Lorenz-kurven er baseret p√• detaljerede indkomstfordelingsdata.`
                : `Detaljerede indkomstfordelingsdata mangler, s√• Lorenz-kurven er en approksimation baseret p√• Gini-koefficienten.`;
            introText.textContent = text;
            plotActualLorenz(giniData.value, bottom10.value, bottom20.value, top10.value, top20.value);
        } else {
            introText.textContent = `Der er ingen tilg√¶ngelige Gini-data for ${countryName}. Simulatoren nedenfor bruger en generisk model.`;
            if (lorenzActualChart) lorenzActualChart.destroy();
        }

        resetSimulation(initialCountryGiniData);
    }

    function plotActualLorenz(gini, bottom10, bottom20, top10, top20) {
      if (lorenzActualChart) lorenzActualChart.destroy();
      const ctx = document.getElementById('lorenzChartActual').getContext('2d');
      let lorenzData;

      if (bottom10 != null && bottom20 != null && top10 != null && top20 != null) {
          const interpolate = (p_target, p1, l1, p2, l2) => l1 + ((l2 - l1) / (p2 - p1)) * (p_target - p1);
          lorenzData = [0, bottom10, bottom20];
          for(let p = 30; p <= 70; p += 10) {
              lorenzData.push(interpolate(p, 20, bottom20, 80, 100 - top20));
          }
          lorenzData.push(100 - top20, 100 - top10, 100);
      } else {
          lorenzData = calculateLorenzFromGini(gini);
      }

      lorenzActualChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: Array.from({ length: 11 }, (_, i) => i * 10),
          datasets: [
            { label: 'Perfekt lighed', data: Array.from({ length: 11 }, (_, i) => i * 10), borderColor: 'grey', borderDash: [5, 5], pointRadius: 0, fill: false },
            { label: 'Faktisk Lorenz-kurve', data: lorenzData, borderColor: 'blue', backgroundColor: 'rgba(0, 0, 255, 0.1)', fill: 0, tension: 0.4 }
          ]
        },
        options: chartOptions('Faktisk indkomstfordeling', 'Kumulativ % af befolkning', 'Kumulativ % af indkomst')
      });
    }

    function plotSimulationLorenz(giniValue) {
        if (lorenzSimChart) lorenzSimChart.destroy();
        const ctx = document.getElementById('lorenzChartSimulation').getContext('2d');
        
        const lorenzData = calculateLorenzFromGini(giniValue);

        lorenzSimChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({ length: 11 }, (_, i) => i * 10),
                datasets: [
                    { label: 'Perfekt lighed', data: Array.from({ length: 11 }, (_, i) => i * 10), borderColor: 'grey', borderDash: [5, 5], pointRadius: 0, fill: false },
                    { label: `Simuleret Lorenz-kurve (Gini: ${(giniValue / 100).toFixed(2)})`, data: lorenzData, borderColor: 'red', backgroundColor: 'rgba(255, 0, 0, 0.1)', fill: 0, tension: 0.4 }
                ]
            },
            options: chartOptions('Simuleret indkomstfordeling', 'Kumulativ % af befolkning', 'Kumulativ % af indkomst')
        });
    }

    const scenarios = {
        // Scenarier der mindsker ulighed (tr√¶kker point fra Gini)
        mikrolaan: { feedback: "Mikrol√•n styrker sm√• iv√¶rks√¶ttere blandt de fattigste. Dette l√∏fter bunden af indkomstfordelingen og mindsker uligheden.", giniModifier: -3.0 },
        uddannelse: { feedback: "Bedre uddannelse giver adgang til jobs med h√∏jere l√∏n, hvilket is√¶r gavner den lavere middelklasse og reducerer uligheden.", giniModifier: -4.0 },
        fairtrade: { feedback: "Fairtrade-aftaler sikrer en mere retf√¶rdig pris for landbrugsvarer. Det √∏ger indkomsten for mange sm√•b√∏nder og mindsker uligheden.", giniModifier: -3.5 },
        demokrati: { feedback: "St√¶rkere demokrati f√∏rer ofte til love, der styrker arbejdstagerrettigheder og sociale sikkerhedsnet, hvilket mindsker uligheden.", giniModifier: -5.0 },
        mereBistand: { feedback: "Velanvendt ulandsbistand i f.eks. sundhed og fattigdomsbek√¶mpelse kan give et direkte l√∏ft til de fattigste og reducere uligheden.", giniModifier: -4.5 },
        offentligInvest: { feedback: "Offentlige investeringer i infrastruktur og uddannelse skaber jobs for en bred del af befolkningen og styrker middelklassen.", giniModifier: -4.0 },

        // Scenarier der √∏ger ulighed (l√¶gger point til Gini)
        landgrabbing: { feedback: "N√•r sm√•b√∏nder mister deres jord, falder de i fattigdom, mens profitten tilfalder en lille elite. Dette √∏ger uligheden markant.", giniModifier: +5.0 },
        korruption: { feedback: "Korruption omdirigerer midler, der skulle have hjulpet samfundet, til en lille elite. De rigeste bliver markant rigere, og uligheden vokser.", giniModifier: +7.0 },
        fdi: { feedback: "Udenlandske investeringer skaber nye jobs, men gavner ofte fagl√¶rt arbejdskraft og kapitalejere mest. Dette kan √∏ge indkomstforskellene.", giniModifier: +3.0 },
        mindreBistand: { feedback: "Mindre ulandsbistand kan betyde nedsk√¶ringer i sociale programmer, der st√∏tter de fattigste, hvilket √∏ger uligheden.", giniModifier: +4.0 },
    };

    function resetSimulation(initialGiniData) {
        const giniToUse = initialGiniData && initialGiniData.value ? initialGiniData.value : 47; // Default til 47 hvis ingen data
        plotSimulationLorenz(giniToUse);
        document.getElementById('scenarioFeedback').textContent = "V√¶lg et scenarie for at se, hvordan det p√•virker indkomstfordelingen.";
    }

    document.getElementById('simulationControls').addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            const scenarioKey = e.target.dataset.scenario;
            if (scenarioKey === 'reset') {
                resetSimulation(initialCountryGiniData);
            } else if (scenarios[scenarioKey]) {
                const scenario = scenarios[scenarioKey];
                const initialGini = (initialCountryGiniData && initialCountryGiniData.value) ? initialCountryGiniData.value : 47;
                
                // Beregn det nye Gini-m√•l
                let newGini = initialGini + scenario.giniModifier;
                newGini = Math.max(0, Math.min(100, newGini)); // Sikrer at Gini er mellem 0 og 100
                
                // Plot resultatet med den nye Gini-v√¶rdi
                plotSimulationLorenz(newGini);
                document.getElementById('scenarioFeedback').textContent = scenario.feedback;
            }
        }
    });

    function calculateLorenzFromGini(giniRaw) {
        const gini = giniRaw / 100;
        const points = 11;
        const lorenz = [];
        for (let i = 0; i < points; i++) {
            const p = i / (points - 1);
            if (p === 0) { lorenz.push(0); continue; }
            // En almindelig anvendt formel til at approksimere Lorenz-kurven fra Gini
            const exponent = (1 + gini) / (1 - gini);
            lorenz.push(Math.pow(p, exponent) * 100);
        }
        return lorenz;
    }

    function chartOptions(title, xLabel, yLabel) {
      return {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          title: { display: true, text: title },
          legend: { position: 'bottom' }
        },
        scales: {
          x: {
            title: { display: true, text: xLabel },
            ticks: { callback: function(value) { return this.getLabelForValue(value) + '%'; } }
          },
          y: {
            title: { display: true, text: yLabel },
            min: 0,
            max: 100,
            ticks: { callback: value => value + '%' }
          }
        }
      };
    }

    const controlsDiv = document.querySelector('.controls');
    const giniButton = document.createElement('button');
    giniButton.id = 'btnGini';
    giniButton.textContent = 'Analyser ulighed';
    controlsDiv.insertBefore(giniButton, document.getElementById('btnGraphs').nextSibling);
    document.getElementById('btnGini').onclick = showGiniSection;

    // SLUT: GINI-SIMULATOR KODE
  </script>
</body>
</html>

