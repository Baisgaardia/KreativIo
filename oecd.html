<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OECD – Sammenligning, Grafer &amp; Notat</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    h1 { margin-bottom: 1rem; }
    .controls, #graphControls { display: flex; gap: .6em; flex-wrap: wrap; align-items: center; margin-bottom: 1rem; }
    select, button, input[type="text"] { font-size: 1rem; padding: .5em; }
    table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
    th, td { border: 1px solid #ddd; padding: .5em; text-align: center; white-space: nowrap; }
    th { background: #f2f2f2; }
    tr:nth-child(even) { background: #fafafa; }
    #assignmentContainer { margin-top: 2rem; padding: 1rem; border: 1px solid #ccc; background: #fafafa; white-space: pre-wrap; }
    #graphSection { margin-top: 2rem; }
    canvas#chart { max-width: 700px; max-height: 400px; width: 100%; height: auto; margin-top: 1rem; }
    .api-citation { position: fixed; bottom: 1rem; left: 1rem; font-size: .8rem; color: #555; max-width: 40%; text-align: left; }
    .footer-copyright { position: fixed; bottom: 1rem; right: 1rem; font-size: .8rem; color: #555; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

  <h1>OECD – Sammenligning, Grafer &amp; Notat</h1>

  <div class="controls">
    <label>Land 1:
      <select id="country1">
        <option disabled selected value="">– vælg land 1 –</option>
      </select>
    </label>

    <label>Land 2:
      <select id="country2">
        <option disabled selected value="">– vælg land 2 –</option>
      </select>
    </label>

    <button id="btnFetch">Hent data</button>
    <button id="btnGenerate" disabled>Generer opgave (Land 1)</button>
    <button id="btnExcel" disabled>Download Excel (Land 1)</button>
    <button id="btnGraphs" disabled>Lav grafer (Land 1)</button>
  </div>

  <div id="tableContainer"></div>
  <div id="assignmentContainer"></div>

  <div id="graphSection" style="display:none">
    <h2>Graf-værktøj (Land 1)</h2>
    <div id="graphControls">
      <input type="text" id="filterInput" placeholder="Søg indikator…" disabled>
      <select id="indicatorSelect" multiple size="8" disabled></select>
      <select id="yearSelect" multiple size="6" disabled></select>
      <button id="last5Btn" disabled>Seneste 5 år</button>
      <button id="last10Btn" disabled>Seneste 10 år</button>
      <button id="plotBtn" disabled>Tegn graf</button>
    </div>
    <canvas id="chart"></canvas>
  </div>

  <div class="api-citation" id="apiCitation"></div>
  <div class="footer-copyright">
    © Allan Baisgaard, Aalborg Handelsgymnasie Turøgade
  </div>

<script>
  // Hjælpefunktion: document.getElementById
  const $ = id => document.getElementById(id);

  // --- KONSTANTER & LISTER ---
  const proxyUrl  = 'https://corsproxy.io/?url=';
  const apiBase   = 'https://sdmx.oecd.org/public/rest/data/';
  const flow      = 'OECD.ECO.MAD,DSD_EO@DF_EO,1.2/';
  const startYear = 2015, endYear = 2024;
  const params    = `?startPeriod=${startYear}&endPeriod=${endYear}&dimensionAtObservation=TIME_PERIOD`;

  // Liste over OECD-lande (fulde navne + trebogstavskoder)
  const countries = [
    {code:'AUS', name:'Australien'},{code:'AUT', name:'Østrig'},{code:'BEL', name:'Belgien'},
    {code:'CAN', name:'Canada'},{code:'CHL', name:'Chile'},{code:'CRI', name:'Costa Rica'},
    {code:'CZE', name:'Tjekkiet'},{code:'DEU', name:'Tyskland'},{code:'DNK', name:'Danmark'},
    {code:'EST', name:'Estland'},{code:'FIN', name:'Finland'},{code:'FRA', name:'Frankrig'},
    {code:'GBR', name:'Storbritannien'},{code:'GRC', name:'Grækenland'},{code:'HUN', name:'Ungarn'},
    {code:'IRL', name:'Irland'},{code:'ISR', name:'Israel'},{code:'ITA', name:'Italien'},
    {code:'JPN', name:'Japan'},{code:'KOR', name:'Sydkorea'},{code:'LVA', name:'Letland'},
    {code:'LTU', name:'Litauen'},{code:'LUX', name:'Luxembourg'},{code:'MEX', name:'Mexico'},
    {code:'NLD', name:'Nederlandene'},{code:'NOR', name:'Norge'},{code:'NZL', name:'New Zealand'},
    {code:'POL', name:'Polen'},{code:'PRT', name:'Portugal'},{code:'SVK', name:'Slovakiet'},
    {code:'SVN', name:'Slovenien'},{code:'ESP', name:'Spanien'},{code:'SWE', name:'Sverige'},
    {code:'CHE', name:'Schweiz'},{code:'TUR', name:'Tyrkiet'},{code:'USA', name:'USA'},
    {code:'COL', name:'Colombia'}
  ];

  // EU-lande med euro
  const euroCountries = [
    'AUT','BEL','EST','FIN','FRA','DEU','GRC','IRL',
    'ITA','LVA','LTU','LUX','NLD','PRT','SVK','SVN','ESP'
  ];

  // De 16 udvalgte nøgletal med alle mulige koder (inkl. harmoniserede)
  const indicators = [
    { codes:['GDPV_ANNPCT'],                 name:'Økonomisk vækst' },
    { codes:['CPI_YTYPCT','CPIH_YTYPCT'],     name:'Samlet inflation' },
    { codes:['PCORE_YTYPCT','PCOREH_YTYPCT'], name:'Kerneinflation' },
    { codes:['UNR'],                          name:'Arbejdsløshedsprocenten' },
    { codes:['XGSV_ANNPCT'],                  name:'Eksport' },
    { codes:['MGSV_ANNPCT'],                  name:'Import' },
    { codes:['CBGDPR'],                       name:'Betalingsbalancen i % af BNP' },
    { codes:['NLGXQ'],                        name:'Offentligt underskud i % af BNP' },
    { codes:['GGFLMQ'],                       name:'Offentlig gæld i % af BNP' },
    { codes:['IRL'],                          name:'Den lange obligationsrente' },
    { codes:['CPV_ANNPCT'],                   name:'Privat forbrug' },
    { codes:['CGV_ANNPCT'],                   name:'Offentligt forbrug' },
    { codes:['ITV_ANNPCT'],                   name:'Offentlige investeringer' },
    { codes:['PDTY'],                         name:'Produktivitet (volumenindeks)' },
    { codes:['CPIDR'],                        name:'Priskonkurrence, indeks 2021' },
    { codes:['ULCDR'],                        name:'Lønomkostninger, indeks 2021' }
  ];

  // --- GLOBAL STATE ---
  let data1 = null,             // Parsed data for Land 1
      data2 = null,             // Parsed data for Land 2
      years = [],               // År 2015–2024
      graphMap   = null,        // data1.dataMap (til grafer)
      graphYears = [],          // Samme som years
      graphChart = null,
      lastCountry1 = null,      // Sidste valgte kode (f.eks. 'DNK')
      lastCountry2 = null,      // Sidste valgte kode for Land 2
      generateIndex = 0;        // Indeks til roterende P0

  // --- FYLD DROPDOWN MED FULDE LANDENAVNE ---
  function populateCountries() {
    const sel1 = $('country1');
    const sel2 = $('country2');
    countries.forEach(c => {
      sel1.add(new Option(c.name, c.code));
      sel2.add(new Option(c.name, c.code));
    });
  }

  // --- HENT RÅ SDMX-JSON VIA CORS-PROXY ---
  async function fetchRaw(countryCode) {
    const allCodes = indicators.flatMap(i => i.codes).join('+');
    const url = apiBase + flow + `${countryCode}.${allCodes}.A` + params;
    const resp = await fetch(proxyUrl + encodeURIComponent(url), {
      headers: { 'Accept': 'application/vnd.sdmx.data+json;version=1.0' }
    });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    return resp.json();
  }

  // --- PARSE SDMX-JSON TIL { years, dataMap } ---
  function parseData(rawJson) {
    const s  = rawJson.structure || rawJson.data.structure;
    const sd = s.dimensions.series;
    const od = s.dimensions.observation[0].values.map(v => v.id);

    // Fyld år (første gang) i stigende rækkefølge
    if (!years.length) {
      years = od.slice().sort((a,b) => +a - +b);
    }

    // Lav tomt dataMap[indikatorkode][år] = null
    const dataMap = {};
    indicators.forEach(ind => {
      dataMap[ind.codes[0]] = {};
      years.forEach(y => dataMap[ind.codes[0]][y] = null);
    });

    // Find serie-dimension (typisk det første array med flere værdier)
    const series = (rawJson.dataSets || rawJson.data.dataSets)[0].series;
    const idx = sd.findIndex(d => d.values.length > 1);

    // Indlæs observationer
    Object.entries(series).forEach(([key, serie]) => {
      const parts = key.split(':').map(x => +x);
      const code  = sd[idx].values[parts[idx]].id; // fx "CPI_YTYPCT" eller "CPIH_YTYPCT"
      Object.entries(serie.observations || {}).forEach(([t, val]) => {
        const år = od[+t];
        indicators.forEach(ind => {
          if (ind.codes.includes(code)) {
            dataMap[ind.codes[0]][år] = val[0];
          }
        });
      });
    });

    return { years, dataMap };
  }

  // --- BYG TABEL FOR ÉT LAND (Land 1) ---
  function buildSingleTable(parsed) {
    const tbl = document.createElement('table');
    const thead = tbl.createTHead();
    const header = thead.insertRow();
    header.insertCell().textContent = 'Nøgletal \\ År';
    years.forEach(y => header.insertCell().textContent = y);

    const tbody = tbl.createTBody();
    indicators.forEach(ind => {
      const row = tbody.insertRow();
      row.insertCell().textContent = ind.name;
      years.forEach(y => {
        const v = parsed.dataMap[ind.codes[0]][y];
        row.insertCell().textContent = v != null ? v.toFixed(2).replace('.',',') : '–';
      });
    });
    return tbl;
  }

  // --- BYG SAMMENLIGNINGSTABEL (Land 1 vs. Land 2) ---
  function buildComparisonTable(parsed1, parsed2, code1, code2) {
    const tbl = document.createElement('table');
    const thead = tbl.createTHead();

    // Øverste header-række: "Nøgletal \ År" + år (colspan=2 pr. år)
    const row1 = thead.insertRow();
    row1.insertCell().textContent = 'Nøgletal \\ År';
    years.forEach(y => {
      const th = row1.insertCell();
      th.colSpan = 2;
      th.textContent = y;
    });

    // Anden header-række: kun koderne (DNK / DEU osv.)
    const row2 = thead.insertRow();
    row2.insertCell(); // tom celle under "Nøgletal \ År"
    years.forEach(_ => {
      const th1 = row2.insertCell();
      th1.textContent = code1;
      const th2 = row2.insertCell();
      th2.textContent = code2;
    });

    // Tabellenes krop
    const tbody = tbl.createTBody();
    indicators.forEach(ind => {
      const row = tbody.insertRow();
      row.insertCell().textContent = ind.name;
      years.forEach(y => {
        const v1 = parsed1.dataMap[ind.codes[0]][y];
        const c1 = row.insertCell();
        c1.textContent = v1 != null ? v1.toFixed(2).replace('.',',') : '–';

        const v2 = parsed2.dataMap[ind.codes[0]][y];
        const c2 = row.insertCell();
        c2.textContent = v2 != null ? v2.toFixed(2).replace('.',',') : '–';
      });
    });
    return tbl;
  }

  // --- DETEKTER ROLLE (Land 1) ---
  function detectRole(dataMap, code) {
    const u    = dataMap['UNR'][endYear];
    const d    = dataMap['GGFLMQ'][endYear];
    const euro = euroCountries.includes(code);
    if (u < 4)        return 'beskæftigelsesministeren';
    if (d > 60)       return 'finansministeren';
    if (!euro)        return 'Nationalbankdirektøren';
                      return 'finansministeren';
  }

  // --- LISTE AF HOVEDPROBLEM (p0) (Land 1) ---
  function problems(dataMap) {
    const p = [];
    const debt = dataMap['GGFLMQ'][endYear];
    if (debt > 100)           p.push('rigtig høj offentlig gæld (>100 % af BNP)');
    else if (debt > 60)       p.push('offentlig gæld > 60 % af BNP');

    if (dataMap['CPI_YTYPCT'][endYear] > 4)
                              p.push('høj samlet inflation');

    if (dataMap['CBGDPR'][endYear] > 6)
                              p.push('stort betalingsbalanceoverskud (> 6 %)');

    const u = dataMap['UNR'][endYear];
    if (u >= 3 && u <= 4)     p.push('fuld beskæftigelse');

    const g = dataMap['GDPV_ANNPCT'][endYear];
    if (g > 2)                p.push('højkonjunktur/overophedning');
    if (g < 1)                p.push('lavkonjunktur');

    const last3 = years.slice(-3);
    if (last3.every(y => dataMap['GDPV_ANNPCT'][y] < 1))
                              p.push('økonomisk krise (3 år i træk < 1 %)');
    if (last3.every(y => dataMap['GDPV_ANNPCT'][y] > 2))
                              p.push('mulig overophedning (3 år i træk > 2 %)');

    return p;
  }

  // --- LISTE AF OVERVEJELSER (p1/p2) (Land 1) ---
  function considerations(dataMap, code) {
    const lines = new Set();
    const u  = dataMap['UNR'][endYear];
    const d  = dataMap['GGFLMQ'][endYear];
    const ci = dataMap['CPI_YTYPCT'][endYear];
    const co = dataMap['PCORE_YTYPCT'][endYear];
    const b  = dataMap['CBGDPR'][endYear];
    const last3 = years.slice(-3);

    // 1) Arbejdsløshed 2–4 % → mismatch/flaskehalse
    if (u >= 2 && u < 4) {
      lines.add('Mismatch på arbejdsmarkedet/flaskehalse');
    }

    // 2) Offentlig gæld > 60 %
    if (d > 60) {
      const euro = euroCountries.includes(code);
      if (euro) {
        lines.add('Begrænsninger ved brug af økonomisk politik som EU-land');
      } else {
        lines.add('En rimelig social fordeling af goderne');
        lines.add('Balance mellem statens indtægter og udgifter');
      }
    }

    // 3) Betalingsbalanceoverskud > 1 % → konkurrenceevnen
    if (b > 1) {
      lines.add('Konkurrenceevnen');
    }

    // 4) Vækst > 2 % tre år i træk
    if (last3.every(y => dataMap['GDPV_ANNPCT'][y] != null && dataMap['GDPV_ANNPCT'][y] > 2)) {
      lines.add('Balance mellem statens indtægter og udgifter');
      lines.add('En rimelig social fordeling af goderne');
    }

    // 5) Vækst < 1 % tre år i træk
    if (last3.every(y => dataMap['GDPV_ANNPCT'][y] != null && dataMap['GDPV_ANNPCT'][y] < 1)) {
      lines.add('Mulige målkonflikter mellem samfundsøkonomiske mål');
    }

    // 6) Høj samlet inflation > 4 % → konkurrenceevnen
    if (ci > 4) {
      lines.add('Konkurrenceevnen');
    }
    // 7) Hvis vi kommer hertil, og ikke allerede har ’Konkurrenceevnen’, så tjek CPI<PCORE
    else if (ci != null && co != null && ci < co) {
      // Tilføj tre nye scenarier for "samlet inflation < kerneinflation"
      lines.add('Konkurrenceevnen');
      lines.add('Betalingsbalancen');
      lines.add('løn-pris-spiral');
    }

    return Array.from(lines);
  }

  // --- BESKRIV PROBLEM (Land 1) – DE 11 EKSEMPLER, NU MED FULDT NAVN ---
  function describeProblem(p0, dataMap, code) {
    const landName = countries.find(c => c.code === code).name;
    const d    = dataMap['GGFLMQ'][endYear];      // Offentlig gæld
    const ci   = dataMap['CPI_YTYPCT'][endYear];   // Samlet inflation
    const co   = dataMap['PCORE_YTYPCT'][endYear]; // Kerneinflation
    const b    = dataMap['CBGDPR'][endYear];       // Betalingsbalance
    const u    = dataMap['UNR'][endYear];          // Arbejdsløshed
    const g    = dataMap['GDPV_ANNPCT'][endYear];  // Økonomisk vækst

    let s = '';

    // 1) Rigtig høj offentlig gæld (> 100 % af BNP)
    if (p0.includes('rigtig høj offentlig gæld')) {
      s = `${landName} har en meget høj offentlig gæld på ${d.toFixed(2)} % af BNP, hvilket skaber ubalancer i landets økonomi samt medfører faldende tillid og udfordringer ift. EU og konjunkturer.`;
    }
    // 2) Offentlig gæld > 60 % + samlet inflation > kerneinflation
    else if (p0.includes('offentlig gæld') && p0.includes('høj samlet inflation')) {
      s = `${landName} har en offentlig gæld på ${d.toFixed(2)} % af BNP og en samlet inflation på ${ci.toFixed(2)} % (kerneinflation: ${co.toFixed(2)} %). Kombinationen af høj gæld og inflation presser både statens indtægter/udgifter og husholdningerne.`;
    }
    // 3) Offentlig gæld > 60 % uden inflation
    else if (p0.includes('offentlig gæld > 60 % af BNP') && !p0.includes('høj samlet inflation')) {
      s = `${landName} har en offentlig gæld på ${d.toFixed(2)} % af BNP i 2024, hvilket presser statens indtægter og udgifter samt svækker mulighederne for at føre finanspolitik. Det påvirker også tillid og EU’s krav.`;
    }
    // 4) Høj samlet inflation + stort betalingsbalanceoverskud (> 6 %)
    else if (p0.includes('høj samlet inflation') && p0.includes('stort betalingsbalanceoverskud')) {
      s = `Den samlede inflation i ${landName} er ${ci.toFixed(2)} % i 2024, mens betalingsbalancen ligger på ${b.toFixed(2)} % af BNP (stort overskud). Det høje inflationsniveau kan underminere konkurrenceevnen, selvom overskuddet på betalingsbalancen er stort. Et stort betalingsbalanceoverskud er et problem i forhold til andre samhandelslande.`;
    }
    // 5) Høj samlet inflation uden betalingsbalancekonsekvens
    else if (p0.includes('høj samlet inflation') && !p0.includes('stort betalingsbalanceoverskud')) {
      s = `Den samlede inflation i ${landName} er ${ci.toFixed(2)} % i 2024, hvilket overstiger kerneinflationen (${co.toFixed(2)} %) og indikerer prisstigninger fra udlandet. Det presser forbrugernes købekraft og konkurrenceevne.`;
    }
    // 6) Stort betalingsbalanceoverskud (> 6 % af BNP)
    else if (p0.includes('stort betalingsbalanceoverskud')) {
      s = `Betalingsbalancen i ${landName} er ${b.toFixed(2)} % af BNP i 2024 (stort overskud). Et kraftigt overskud kan udfordre landets konkurrenceevne og samhandel med andre lande.`;
    }
    // 7) Fuld beskæftigelse (arbejdsløshed 3–4 %)
    else if (p0.includes('fuld beskæftigelse')) {
      s = `Arbejdsløsheden i ${landName} er på blot ${u.toFixed(2)} % (fuld beskæftigelse), hvilket kan skabe flaskehalsproblemer og mismatchproblemer i økonomien.`;
    }
    // 8) Højkonjunktur/overophedning (vækst > 2 %)
    else if (p0.includes('højkonjunktur/overophedning')) {
      s = `Økonomien i ${landName} vokser med ${g.toFixed(2)} % i 2024, hvilket peger på overophedning. Derfor kan der være behov for at lægge en dæmper på den økonomiske udvikling.`;
    }
    // 9) Lavkonjunktur (vækst < 1 %)
    else if (p0.includes('lavkonjunktur')) {
      s = `Økonomien i ${landName} vokser kun med ${g.toFixed(2)} % i 2024, hvilket indikerer lavkonjunktur som på sigt kan udvikle sig til en krise. Derfor er der behov for at sætte lidt/mere gang i landets økonomi.`;
    }
    // 10) Økonomisk krise (3 år i træk < 1 %)
    else if (p0.includes('økonomisk krise')) {
      const y1 = years[years.length - 3],
            y2 = years[years.length - 2],
            y3 = years[years.length - 1];
      const g1 = dataMap['GDPV_ANNPCT'][y1].toFixed(2);
      const g2 = dataMap['GDPV_ANNPCT'][y2].toFixed(2);
      const g3 = dataMap['GDPV_ANNPCT'][y3].toFixed(2);
      s = `${landName} har oplevet vækstrater på under 1 % i tre år i træk (${y1}: ${g1} %, ${y2}: ${g2} %, ${y3}: ${g3} %), derfor er der behov for at kickstarte landets økonomi.`;
    }
    // 11) Mulig overophedning (3 år i træk > 2 %)
    else if (p0.includes('mulig overophedning')) {
      const y1 = years[years.length - 3],
            y2 = years[years.length - 2],
            y3 = years[years.length - 1];
      const g1 = dataMap['GDPV_ANNPCT'][y1].toFixed(2);
      const g2 = dataMap['GDPV_ANNPCT'][y2].toFixed(2);
      const g3 = dataMap['GDPV_ANNPCT'][y3].toFixed(2);
      s = `${landName} har haft vækst over 2 % i tre år i træk (${y1}: ${g1} %, ${y2}: ${g2} %, ${y3}: ${g3} %), hvorfor der kan være behov for at lægge en dæmper på den økonomiske udvikling.`;
    }
    // Fallback (kun hvis p0 er tom – men normalt kommer p0 altid med ét af ovenstående)
    else {
      s = `${landName} står med udfordringer i økonomien i forhold til: ${p0}.`;
    }

    return s;
  }

  // --- DOWNLOAD EXCEL (Land 1) ---
  function downloadExcel() {
    if (!data1) return;
    const aoa = [['Nøgletal \\ År', ...years]];
    indicators.forEach(ind => {
      const row = [ind.name];
      years.forEach(y => {
        const v = data1.dataMap[ind.codes[0]][y];
        row.push(v != null ? v.toFixed(2).replace('.',',') : '');
      });
      aoa.push(row);
    });
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(aoa);
    XLSX.utils.book_append_sheet(wb, ws, 'Land 1');
    XLSX.writeFile(wb, `OECD_${$('country1').value}.xlsx`);
  }

  // --- GRAF-VÆRKTØJ (Land 1) ---
  function populateGraphControls() {
    const f   = $('filterInput'),
          iS  = $('indicatorSelect'),
          yS  = $('yearSelect'),
          l5  = $('last5Btn'),
          l10 = $('last10Btn'),
          pB  = $('plotBtn');

    // Fyld indikator-select
    iS.innerHTML = '';
    indicators.forEach(ind => iS.append(new Option(ind.name, ind.codes[0])));

    // Fyld år
    yS.innerHTML = '';
    yS.append(new Option('Alle år','all', true, true));
    graphYears.forEach(y => yS.append(new Option(y,y)));

    [f,iS,yS,l5,l10,pB].forEach(el => el.disabled = false);
    f.value = '';

    f.oninput = () => {
      const term = f.value.toLowerCase();
      Array.from(iS.options).forEach(o =>
        o.style.display = o.text.toLowerCase().includes(term) ? '' : 'none'
      );
    };

    l5.onclick = () => {
      const opts = Array.from(yS.options),
            last = graphYears.slice(-5).map(String);
      opts.forEach(o => o.selected = (o.value !== 'all' && last.includes(o.value)));
    };

    l10.onclick = () => {
      const opts = Array.from(yS.options),
            last = graphYears.slice(-10).map(String);
      opts.forEach(o => o.selected = (o.value !== 'all' && last.includes(o.value)));
    };

    pB.onclick = () => {
      const selCodes = Array.from(iS.options)
        .filter(o => o.selected && o.style.display !== 'none')
        .map(o => o.value);
      if (!selCodes.length) return alert('Vælg mindst én indikator');

      const selYs = Array.from(yS.options).filter(o => o.selected).map(o => o.value);
      const useAll = selYs.includes('all') || selYs.length === 0;
      const labels = useAll ? graphYears : selYs;

      const datasets = selCodes.map((code,i) => ({
        label: indicators.find(ind => ind.codes[0] === code).name,
        data: labels.map(y => +(graphMap[code][y] || 0)),
        borderColor: `hsl(${i*360/selCodes.length},70%,45%)`,
        fill: false,
        spanGaps: true
      }));

      if (graphChart) graphChart.destroy();
      graphChart = new Chart($('chart'), {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position:'bottom' } },
          scales: {
            x: { title: { display:true, text:'År' } },
            y: { title: { display:true, text:'Værdi' } }
          }
        }
      });
    };
  }

  // --- INIT & EVENT-HANDLERS ---
  document.addEventListener('DOMContentLoaded', () => {
    populateCountries();
    $('apiCitation').textContent =
      `Source: OECD SDMX API (https://sdmx.oecd.org). © OECD. Nyeste år: ${endYear}.`;

    // “Hent data”-knap
    $('btnFetch').onclick = async () => {
      const c1 = $('country1').value;
      const c2 = $('country2').value;

      // 1) Hvis Land 1 er nyt eller ikke hentet før → hent Land 1
      if (!data1 || c1 !== lastCountry1) {
        if (!c1) return alert('Vælg et land 1');
        $('tableContainer').textContent = 'Henter data for Land 1…';

        try {
          const raw1 = await fetchRaw(c1);
          data1 = parseData(raw1);
          lastCountry1 = c1;

          // Nulstil Land 2, da vi har nyt Land 1
          data2 = null;
          lastCountry2 = null;
          $('country2').value = '';
          $('assignmentContainer').textContent = '';
          $('graphSection').style.display = 'none';

          // Vis enkelt-landstabel (kun koden som overskrift)
          $('tableContainer').textContent = '';
          const tbl1 = buildSingleTable(data1);
          const caption1 = document.createElement('h2');
          caption1.textContent = c1;
          $('tableContainer').append(caption1, tbl1);

          // Opdater graf-data
          graphMap   = data1.dataMap;
          graphYears = data1.years;

          // Aktiver knapper for Land 1
          $('btnGenerate').disabled = false;
          $('btnExcel').disabled    = false;
          $('btnGraphs').disabled   = false;
        }
        catch(err) {
          console.error(err);
          $('tableContainer').textContent = 'Fejl ved hentning/parsing Land 1.';
          data1 = null;
        }
      }
      // 2) Ellers: hent Land 2, hvis den er valgt og ikke hentet før
      else if (!data2 && c2 && c2 !== lastCountry2) {
        $('tableContainer').textContent = 'Henter data for Land 2…';
        try {
          const raw2 = await fetchRaw(c2);
          data2 = parseData(raw2);
          lastCountry2 = c2;

          // Vis sammenligningstabel (kun koder i header)
          $('tableContainer').textContent = '';
          const compTable = buildComparisonTable(data1, data2, c1, c2);
          const captionComp = document.createElement('h2');
          captionComp.textContent = `Sammenligning: ${c1} vs. ${c2}`;
          $('tableContainer').append(captionComp, compTable);

          // Knapper for Land 1 forbliver aktive
        }
        catch(err) {
          console.error(err);
          $('tableContainer').textContent = 'Fejl ved hentning/parsing Land 2.';
          data2 = null;
        }
      }
      // 3) Ellers: ingen ny handling
      else {
        if (!c1) return alert('Vælg et land 1');
        if (!c2) return alert('Land 2 ikke valgt. Vælg et land 2 for sammenligning.');
        if (data2 && c2 === lastCountry2)
          return alert('Land 2 er allerede hentet. Vælg et nyt Land 2 eller skift Land 1.');
      }
    };

    // “Generer opgave” (Land 1) – nu med dynamiske punkt 1 og 2
    $('btnGenerate').onclick = () => {
      if (!data1) return alert('Hent data for Land 1 først');
      const code = lastCountry1;
      const fullName = countries.find(c => c.code === code).name;

      // Hovedproblem p0
      const prList = problems(data1.dataMap);
      if (!prList.length) return alert('Ingen ubalancer fundet for Land 1.');
      const idx = generateIndex % prList.length;
      const p0  = prList[idx];
      generateIndex++;

      // Beskriv det overordnede problem
      const overordnet = describeProblem(p0, data1.dataMap, code);

      // Hent alle mulige overvejelser (p1, p2 osv.)
      const allCond = considerations(data1.dataMap, code);

      // Vælg to første overvejelser til punkterne
      let bullet1 = allCond[0] || '';
      let bullet2 = allCond[1] || '';
      if (!bullet2) bullet2 = ''; // Hvis kun ét eller ingen, lad punkt 2 være tomt

      $('assignmentContainer').textContent =
`Som rådgiver for regeringen i ${fullName} skal du skrive et notat på maksimalt 600 ord.

${overordnet}

Notatet skal indeholde en præsentation af egnede tiltag med det formål at løse: ${p0}.

1. ${bullet1}
2. ${bullet2}

Bedømmelsen foretages på baggrund af en helhedsvurdering. Der er fokus på din evne til at strukturere notatet og vise, at du kan forholde dig til enten finanspolitikken (to instrumenter med direkte/indirekte effekt), pengepolitik (evt. begrænsninger og instrumenter) eller valutapolitikken (evt. begrænsninger og instrumenter).`;
    };

    // “Download Excel” (Land 1)
    $('btnExcel').onclick = downloadExcel;

    // “Lav grafer” (Land 1)
    $('btnGraphs').onclick = () => {
      if (!data1) return alert('Hent data for Land 1 først');
      $('graphSection').style.display = 'block';
      populateGraphControls();
      $('graphSection').scrollIntoView({ behavior: 'smooth' });
    };
  });
</script>

</body>
</html>
