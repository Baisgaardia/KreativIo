<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Macro Trumps - Multiplayer</title>
    <!-- PeerJS bibliotek -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --primary: #1a1a2e;
            --accent: #e94560;
            --success: #4ecca3;
            --gold: #f1c40f;
            --dark-blue: #16213e;
            --light: #e1e1e1;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: #0f0f1a;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            color: var(--light);
            overflow-x: hidden;
        }

        /* Lobby UI */
        #setup-container {
            width: 90%;
            max-width: 450px;
            margin-top: 30px;
            text-align: center;
            background: var(--dark-blue);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }

        .btn {
            background: var(--success);
            color: #1a1a2e;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            transition: all 0.2s;
        }

        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-accent { background: var(--accent); color: white; }

        input, select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: 2px solid #0f3460;
            background: #1a1a2e;
            color: white;
            box-sizing: border-box;
        }

        .player-tag {
            display: inline-block;
            padding: 5px 12px;
            margin: 5px;
            background: var(--accent);
            border-radius: 15px;
            font-size: 14px;
        }

        /* Spil UI */
        #game-board {
            display: none;
            width: 100%;
            max-width: 480px;
            flex-direction: column;
            padding: 10px;
            box-sizing: border-box;
        }

        .status-bar {
            background: var(--accent);
            width: 100%;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .card {
            background: white;
            color: #333;
            width: 100%;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            margin-top: 10px;
        }

        .card-header {
            background: #f1f1f1;
            padding: 15px;
            text-align: center;
            border-bottom: 2px solid #ddd;
        }

        .card-header img {
            width: 100px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .card-header h2 { margin: 10px 0 0 0; font-size: 24px; color: var(--primary); }

        .stat-list {
            max-height: 42vh;
            overflow-y: auto;
            margin: 0; padding: 0;
            list-style: none;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 20px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .stat-item:hover { background: #f9f9f9; }
        .stat-item.active { background: #e8f4fd; border-left: 6px solid var(--success); }
        .stat-item.disabled { opacity: 0.5; cursor: default; }

        .stat-name { font-size: 14px; font-weight: 500; }
        .stat-value { font-weight: bold; color: var(--accent); }
        .fallback-year { font-size: 10px; color: #888; display: block; font-weight: normal; }

        .info-panel {
            display: flex;
            justify-content: space-between;
            background: var(--dark-blue);
            padding: 10px 20px;
            border-radius: 10px;
            margin-top: 10px;
            font-size: 13px;
        }

        /* Overlay */
        #overlay {
            position: fixed;
            top:0; left:0; right:0; bottom:0;
            background: rgba(0,0,0,0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            text-align: center;
            padding: 20px;
        }

        .war-pot-ui {
            background: var(--gold);
            color: black;
            padding: 5px 15px;
            border-radius: 15px;
            font-weight: bold;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>

    <div class="status-bar" id="game-status">MACRO TRUMPS</div>

    <div id="setup-container">
        <h1>Macro Trumps</h1>
        <div id="lobby-view">
            <select id="game-year">
                <option value="2024">Data-år: 2024</option>
                <option value="2023">Data-år: 2023</option>
                <option value="2022">Data-år: 2022</option>
                <option value="2021">Data-år: 2021</option>
                <option value="2020">Data-år: 2020</option>
            </select>
            
            <button class="btn" id="btn-host">Opret Rum (Vært)</button>
            <div id="host-info" style="display:none">
                <p>Del dette ID: <b id="peer-id-display" style="color:var(--gold)">---</b></p>
                <div id="connected-players" style="margin:15px 0;"></div>
                <button class="btn btn-accent" id="btn-start" disabled>Start Spillet</button>
            </div>

            <hr style="border:0; border-top:1px solid #0f3460; margin:20px 0;">

            <input type="text" id="join-name" placeholder="Dit navn">
            <input type="text" id="join-id" placeholder="Værtens ID">
            <button class="btn btn-accent" id="btn-join">Deltag i Spil</button>
        </div>
    </div>

    <div id="game-board">
        <div class="info-panel">
            <div>Dine kort: <b id="my-deck-count">0</b></div>
            <div>Pulje: <b id="pot-count">0</b></div>
            <div id="turn-display">Venter...</div>
        </div>

        <div class="card">
            <div class="card-header">
                <img id="country-flag" src="" alt="Flag">
                <h2 id="country-name">Land</h2>
            </div>
            <ul class="stat-list" id="stat-list"></ul>
        </div>
    </div>

    <div id="overlay">
        <div class="war-pot-ui" id="overlay-war" style="display:none">KRIGS-PULJE!</div>
        <h1 id="overlay-title">RESULTAT</h1>
        <div id="overlay-details" style="margin:20px; font-size:18px;"></div>
        <div id="overlay-winner" style="color:var(--gold); font-size:26px; font-weight:bold"></div>
    </div>

    <script>
        // --- KONFIGURATION ---
        const countries = {
            AUS: 'Australien', AUT: 'Østrig', BEL: 'Belgien', CAN: 'Canada', CHE: 'Schweiz', CHL: 'Chile', COL: 'Colombia', CRI: 'Costa Rica', CZE: 'Tjekkiet', DEU: 'Tyskland', DNK: 'Danmark', ESP: 'Spanien', EST: 'Estland', FIN: 'Finland', FRA: 'Frankrig', GBR: 'Storbritannien', GRC: 'Grækenland', HUN: 'Ungarn', IRL: 'Irland', ISL: 'Island', ISR: 'Israel', ITA: 'Italien', JPN: 'Japan', KOR: 'Sydkorea', LTU: 'Litauen', LUX: 'Luxembourg', LVA: 'Letland', MEX: 'Mexico', NLD: 'Nederlandene', NOR: 'Norge', NZL: 'New Zealand', POL: 'Polen', PRT: 'Portugal', SVK: 'Slovakiet', SVN: 'Slovenien', SWE: 'Sverige', TUR: 'Tyrkiet', USA: 'USA'
        };

        const indicatorMeta = {
            'GDPV_ANNPCT': { name: 'Økonomisk vækst', lowWins: false },
            'CPI_YTYPCT': { name: 'Samlet inflation', lowWins: true },
            'PCORE_YTYPCT': { name: 'Kerneinflation', lowWins: true },
            'UNR': { name: 'Arbejdsløshedsprocenten', lowWins: true },
            'XGSV_ANNPCT': { name: 'Eksport', lowWins: false },
            'MGSV_ANNPCT': { name: 'Import', lowWins: false },
            'CBGDPR': { name: 'Betalingsbalancen i % af BNP', lowWins: false },
            'NLGXQ': { name: 'Offentligt underskud i % af BNP', lowWins: true },
            'GGFLMQ': { name: 'Offentlig gæld i % af BNP', lowWins: true },
            'IRL': { name: 'Den lange obligationsrente', lowWins: true },
            'CPV_ANNPCT': { name: 'Privat forbrug', lowWins: false },
            'CGV_ANNPCT': { name: 'Offentligt forbrug', lowWins: false },
            'ITV_ANNPCT': { name: 'Offentlige investeringer', lowWins: false },
            'PDTY': { name: 'Produktivitet (volumenindeks)', lowWins: false },
            'CPIDR': { name: 'Priskonkurrence, indeks 2021', lowWins: true },
            'ULCDR': { name: 'Lønomkostninger, indeks 2021', lowWins: true }
        };

        const iso3to2 = { AUS:'au', AUT:'at', BEL:'be', CAN:'ca', CHE:'ch', CHL:'cl', COL:'co', CRI:'cr', CZE:'cz', DEU:'de', DNK:'dk', ESP:'es', EST:'ee', FIN:'fi', FRA:'fr', GBR:'gb', GRC:'gr', HUN:'hu', IRL:'ie', ISL:'is', ISR:'il', ITA:'it', JPN:'jp', KOR:'kr', LTU:'lt', LUX:'lu', LVA:'lv', MEX:'mx', NLD:'nl', NOR:'no', NZL:'nz', POL:'pl', PRT:'pt', SVK:'sk', SVN:'si', SWE:'se', TUR:'tr', USA:'us' };

        // --- TILSTAND ---
        let peer, connections = {}; 
        let myId, hostId;
        let myDeck = [], hostPotSize = 0, currentPotCards = [];
        let isHost = false, selectedYear = "2024";
        let players = []; 
        let turnIdx = 0;
        let roundResponses = {};

        // --- HJÆLPEFUNKTIONER ---
        function getStat(card, key, targetYear) {
            let year = parseInt(targetYear);
            while (year >= 2018) {
                const val = card.dataMap[key][year.toString()];
                if (val !== null && val !== undefined) return { value: val, year: year };
                year--;
            }
            return { value: 0, year: 'N/A' };
        }

        // --- NETVÆRK ---
        document.getElementById('btn-host').onclick = startHost;
        document.getElementById('btn-join').onclick = startJoin;
        document.getElementById('btn-start').onclick = hostStartGame;

        function startHost() {
            isHost = true;
            selectedYear = document.getElementById('game-year').value;
            peer = new Peer();
            peer.on('open', id => {
                myId = id;
                document.getElementById('host-info').style.display = 'block';
                document.getElementById('peer-id-display').innerText = id;
                players.push({id: id, name: "Vært (Dig)", active: true});
                renderLobby();
            });
            peer.on('connection', conn => {
                connections[conn.peer] = conn;
                conn.on('data', data => handleData(data, conn.peer));
            });
        }

        function startJoin() {
            const hId = document.getElementById('join-id').value;
            const uName = document.getElementById('join-name').value || "Spiller";
            if(!hId) return;
            peer = new Peer();
            peer.on('open', id => {
                myId = id;
                const conn = peer.connect(hId);
                connections[hId] = conn;
                conn.on('open', () => {
                    conn.send({type: 'JOIN', name: uName});
                });
                conn.on('data', data => handleData(data, hId));
                document.getElementById('lobby-view').innerHTML = "<h3>Forbundet som " + uName + "! Venter på start...</h3>";
            });
        }

        function handleData(data, senderId) {
            if (isHost && data.type === 'JOIN') {
                players.push({id: senderId, name: data.name, active: true});
                broadcast({type: 'LOBBY_UPDATE', players: players});
                renderLobby();
            }

            if (isHost && data.type === 'MOVE') {
                roundResponses[senderId] = { value: data.value, year: data.year, card: data.card };
                const activePlayers = players.filter(p => p.active);
                if (Object.keys(roundResponses).length === activePlayers.length) {
                    processHostRound(data.cat);
                }
            }

            switch(data.type) {
                case 'LOBBY_UPDATE': players = data.players; break;
                case 'START':
                    myDeck = data.decks[players.findIndex(p => p.id === myId)];
                    selectedYear = data.year;
                    turnIdx = data.turnIdx;
                    players = data.players;
                    initBoard();
                    break;
                case 'ROUND_START':
                    showOverlay("KATEGORI VALGT", indicatorMeta[data.cat].name);
                    setTimeout(() => {
                        const stat = getStat(myDeck[0], data.cat, selectedYear);
                        sendToHost({type: 'MOVE', cat: data.cat, value: stat.value, year: stat.year, card: myDeck[0]});
                    }, 1500);
                    break;
                case 'RESULT':
                    resolveResult(data);
                    break;
            }
        }

        function broadcast(data) {
            Object.values(connections).forEach(c => c.send(data));
        }

        function sendToHost(data) {
            if (isHost) handleData(data, myId);
            else connections[hostId].send(data);
        }

        // --- HOST LOGIK ---
        async function hostStartGame() {
            const codes = Object.keys(countries).sort(() => Math.random() - 0.5);
            const decks = players.map(() => []);
            for(let i=0; i < codes.length; i++) {
                const res = await fetch(`./data/${codes[i]}.json`);
                const json = await res.json();
                json.code = codes[i];
                decks[i % players.length].push(json);
            }
            const startMsg = { type: 'START', decks, year: selectedYear, players, turnIdx: 0 };
            broadcast(startMsg);
            handleData(startMsg, myId);
        }

        function processHostRound(cat) {
            const meta = indicatorMeta[cat];
            let bestVal = meta.lowWins ? Infinity : -Infinity;
            let winners = [];

            Object.entries(roundResponses).forEach(([id, res]) => {
                const v = res.value;
                if (meta.lowWins) {
                    if (v < bestVal) { bestVal = v; winners = [id]; }
                    else if (v === bestVal) winners.push(id);
                } else {
                    if (v > bestVal) { bestVal = v; winners = [id]; }
                    else if (v === bestVal) winners.push(id);
                }
            });

            const cardsInRound = Object.values(roundResponses).map(r => r.card);
            currentPotCards.push(...cardsInRound);
            
            let nextTurn;
            if (winners.length === 1) {
                const winCards = [...currentPotCards];
                currentPotCards = [];
                nextTurn = players.findIndex(p => p.id === winners[0]);
                const resMsg = { type: 'RESULT', winners, details: roundResponses, cat, potSize: 0, winCards, nextTurn };
                broadcast(resMsg); resolveResult(resMsg);
            } else {
                nextTurn = (turnIdx + 1) % players.length;
                while(!players[nextTurn].active) nextTurn = (nextTurn + 1) % players.length;
                const resMsg = { type: 'RESULT', winners, details: roundResponses, cat, potSize: currentPotCards.length, nextTurn };
                broadcast(resMsg); resolveResult(resMsg);
            }
            roundResponses = {};
        }

        // --- SPIL FLOW ---
        function initBoard() {
            document.getElementById('setup-container').style.display = 'none';
            document.getElementById('game-board').style.display = 'flex';
            updateBoard();
        }

        function updateBoard() {
            if (myDeck.length === 0) {
                document.getElementById('game-status').innerText = "UDE AF SPILLET";
                return;
            }
            const card = myDeck[0];
            document.getElementById('country-name').innerText = countries[card.code];
            document.getElementById('country-flag').src = `https://flagcdn.com/w160/${iso3to2[card.code]}.png`;
            document.getElementById('my-deck-count').innerText = myDeck.length;

            const activeP = players[turnIdx];
            document.getElementById('turn-display').innerText = "Tur: " + activeP.name;
            const isMyTurn = activeP.id === myId;

            const list = document.getElementById('stat-list');
            list.innerHTML = '';
            Object.keys(indicatorMeta).forEach(key => {
                const stat = getStat(card, key, selectedYear);
                const li = document.createElement('li');
                li.className = `stat-item ${!isMyTurn ? 'disabled' : ''}`;
                li.innerHTML = `<div>${indicatorMeta[key].name}${stat.year != selectedYear ? `<span class="fallback-year">(${stat.year}-data)</span>` : ''}</div>
                                <span class="stat-value">${stat.value.toFixed(2)}</span>`;
                if(isMyTurn) li.onclick = () => {
                    broadcast({type: 'ROUND_START', cat: key});
                    handleData({type: 'ROUND_START', cat: key}, myId);
                };
                list.appendChild(li);
            });
        }

        function resolveResult(data) {
            const isWar = data.winners.length > 1;
            const detailHtml = Object.entries(data.details).map(([id, res]) => {
                const p = players.find(x => x.id === id).name;
                const y = res.year != selectedYear ? `<small>(${res.year})</small>` : '';
                return `${p}: <b>${res.value.toFixed(2)}</b> ${y}`;
            }).join('<br>');

            document.getElementById('overlay-war').style.display = isWar ? 'block' : 'none';
            document.getElementById('overlay-title').innerText = isWar ? "KRIG!" : "RUNDENS VINDER";
            document.getElementById('overlay-details').innerHTML = detailHtml;
            document.getElementById('overlay-winner').innerText = isWar ? "Puljen vokser!" : players.find(p => p.id === data.winners[0]).name;
            document.getElementById('overlay').style.display = 'flex';

            setTimeout(() => {
                document.getElementById('overlay').style.display = 'none';
                const myOldCard = myDeck.shift();
                if (!isWar && data.winners.includes(myId)) {
                    myDeck.push(myOldCard, ...data.winCards.filter(c => c.code !== myOldCard.code));
                }
                turnIdx = data.nextTurn;
                document.getElementById('pot-count').innerText = data.potSize;
                if(myDeck.length === 0) players.find(p => p.id === myId).active = false;
                updateBoard();
            }, 4000);
        }

        function renderLobby() {
            document.getElementById('connected-players').innerHTML = players.map(p => `<span class="player-tag">${p.name}</span>`).join('');
            if(isHost && players.length >= 2) document.getElementById('btn-start').disabled = false;
        }

        function showOverlay(title, detail) {
            document.getElementById('overlay-title').innerText = title;
            document.getElementById('overlay-details').innerHTML = detail;
            document.getElementById('overlay-winner').innerText = "";
            document.getElementById('overlay').style.display = 'flex';
            setTimeout(() => { if(document.getElementById('overlay-winner').innerText==="") document.getElementById('overlay').style.display='none'; }, 1500);
        }
    </script>
</body>
</html>