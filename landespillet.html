<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Makrodysten! - Multiplayer</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --primary: #1a1a2e;
            --accent: #e94560;
            --success: #4ecca3;
            --gold: #f1c40f;
            --dark-blue: #16213e;
            --light: #e1e1e1;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: #0f0f1a;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            color: var(--light);
            overflow: hidden;
        }

        #setup-container {
            width: 90%;
            max-width: 450px;
            margin-top: 30px;
            text-align: center;
            background: var(--dark-blue);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            z-index: 10;
        }

        .btn {
            background: var(--success);
            color: #1a1a2e;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            transition: all 0.2s;
        }

        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-accent { background: var(--accent); color: white; }

        input, select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: 2px solid #0f3460;
            background: #1a1a2e;
            color: white;
            box-sizing: border-box;
        }

        .player-tag {
            display: inline-block;
            padding: 5px 12px;
            margin: 5px;
            background: var(--accent);
            border-radius: 15px;
            font-size: 14px;
        }

        #game-board {
            display: none;
            width: 100%;
            max-width: 480px;
            flex-direction: column;
            padding: 10px;
            box-sizing: border-box;
        }

        .status-bar {
            background: var(--accent);
            width: 100%;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .card {
            background: white;
            color: #333;
            width: 100%;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            margin-top: 10px;
        }

        .card-header {
            background: #f1f1f1;
            padding: 15px;
            text-align: center;
            border-bottom: 2px solid #ddd;
        }

        .card-header img { width: 100px; border-radius: 5px; border: 1px solid #ddd; }
        .card-header h2 { margin: 10px 0 0 0; font-size: 24px; color: var(--primary); }

        .stat-list { max-height: 40vh; overflow-y: auto; margin: 0; padding: 0; list-style: none; }
        .stat-item { display: flex; justify-content: space-between; padding: 12px 20px; border-bottom: 1px solid #eee; cursor: pointer; }
        .stat-item:hover { background: #f9f9f9; }
        .stat-item.active { background: #e8f4fd; border-left: 6px solid var(--success); }
        .stat-item.disabled { opacity: 0.5; cursor: default; }

        .stat-name { font-size: 14px; font-weight: 500; }
        .stat-value { font-weight: bold; color: var(--accent); }
        .fallback-year { font-size: 10px; color: #888; display: block; font-weight: normal; }

        .info-panel {
            display: flex;
            justify-content: space-between;
            background: var(--dark-blue);
            padding: 10px 20px;
            border-radius: 10px;
            margin-top: 10px;
            font-size: 13px;
        }

        #overlay {
            position: fixed;
            top:0; left:0; right:0; bottom:0;
            background: rgba(0,0,0,0.92);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            text-align: center;
            padding: 20px;
        }

        #overlay-details {
            margin: 20px;
            font-size: 18px;
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
        }

        .war-pot-ui {
            background: var(--gold);
            color: black;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>

    <div class="status-bar" id="game-status">MAKRODYSTEN!</div>

    <div id="setup-container">
        <h1>Makrodysten!</h1>
        <div id="lobby-view">
            <select id="game-year">
                <option value="2024">Data-år: 2024</option>
                <option value="2023">Data-år: 2023</option>
                <option value="2022">Data-år: 2022</option>
                <option value="2021">Data-år: 2021</option>
                <option value="2020">Data-år: 2020</option>
            </select>
            
            <button class="btn" id="btn-host">Opret Rum (Vært)</button>
            <div id="host-info" style="display:none">
                <p>Del dette ID: <b id="peer-id-display" style="color:var(--gold)">---</b></p>
                <div id="connected-players" style="margin:15px 0;"></div>
                <button class="btn btn-accent" id="btn-start" disabled>Start Spillet</button>
            </div>

            <hr style="border:0; border-top:1px solid #0f3460; margin:20px 0;">
            <input type="text" id="join-name" placeholder="Dit navn">
            <input type="text" id="join-id" placeholder="Værtens ID">
            <button class="btn btn-accent" id="btn-join">Deltag i Spil</button>
        </div>
    </div>

    <div id="game-board">
        <div class="info-panel">
            <div>Kort: <b id="my-deck-count">0</b></div>
            <div>Pulje: <b id="pot-count">0</b></div>
            <div id="turn-display">Venter...</div>
        </div>
        <div class="card">
            <div class="card-header">
                <img id="country-flag" src="" alt="Flag">
                <h2 id="country-name">Land</h2>
            </div>
            <ul class="stat-list" id="stat-list"></ul>
        </div>
    </div>

    <div id="overlay">
        <div class="war-pot-ui" id="overlay-war" style="display:none">KRIGS-PULJE!</div>
        <h1 id="overlay-title">TITEL</h1>
        <div id="overlay-details"></div>
        <div id="overlay-winner" style="color:var(--gold); font-size:26px; font-weight:bold; margin-bottom: 25px;"></div>
        <button class="btn btn-accent" id="overlay-continue-btn" style="display:none; width: 220px;">FORTSÆT</button>
    </div>

    <script>
        // --- DATA ---
        const countries = {
            AUS: 'Australien', AUT: 'Østrig', BEL: 'Belgien', CAN: 'Canada', CHE: 'Schweiz', CHL: 'Chile', COL: 'Colombia', CRI: 'Costa Rica', CZE: 'Tjekkiet', DEU: 'Tyskland', DNK: 'Danmark', ESP: 'Spanien', EST: 'Estland', FIN: 'Finland', FRA: 'Frankrig', GBR: 'Storbritannien', GRC: 'Grækenland', HUN: 'Ungarn', IRL: 'Irland', ISL: 'Island', ISR: 'Israel', ITA: 'Italien', JPN: 'Japan', KOR: 'Sydkorea', LTU: 'Litauen', LUX: 'Luxembourg', LVA: 'Letland', MEX: 'Mexico', NLD: 'Nederlandene', NOR: 'Norge', NZL: 'New Zealand', POL: 'Polen', PRT: 'Portugal', SVK: 'Slovakiet', SVN: 'Slovenien', SWE: 'Sverige', TUR: 'Tyrkiet', USA: 'USA'
        };

        const indicatorMeta = {
            'GDPV_ANNPCT': { name: 'Økonomisk vækst', lowWins: false },
            'CPI_YTYPCT': { name: 'Samlet inflation', lowWins: true },
            'PCORE_YTYPCT': { name: 'Kerneinflation', lowWins: true },
            'UNR': { name: 'Arbejdsløshedsprocenten', lowWins: true },
            'XGSV_ANNPCT': { name: 'Eksport', lowWins: false },
            'MGSV_ANNPCT': { name: 'Import', lowWins: false },
            'CBGDPR': { name: 'Betalingsbalancen i % af BNP', lowWins: false },
            'NLGXQ': { name: 'Offentligt underskud i % af BNP', lowWins: true },
            'GGFLMQ': { name: 'Offentlig gæld i % af BNP', lowWins: true },
            'IRL': { name: 'Den lange obligationsrente', lowWins: true },
            'CPV_ANNPCT': { name: 'Privat forbrug', lowWins: false },
            'CGV_ANNPCT': { name: 'Offentligt forbrug', lowWins: false },
            'ITV_ANNPCT': { name: 'Offentlige investeringer', lowWins: false },
            'PDTY': { name: 'Produktivitet (volumenindeks)', lowWins: false },
            'CPIDR': { name: 'Priskonkurrence, indeks 2021', lowWins: true },
            'ULCDR': { name: 'Lønomkostninger, indeks 2021', lowWins: true }
        };

        const iso3to2 = { AUS:'au', AUT:'at', BEL:'be', CAN:'ca', CHE:'ch', CHL:'cl', COL:'co', CRI:'cr', CZE:'cz', DEU:'de', DNK:'dk', ESP:'es', EST:'ee', FIN:'fi', FRA:'fr', GBR:'gb', GRC:'gr', HUN:'hu', IRL:'ie', ISL:'is', ISR:'il', ITA:'it', JPN:'jp', KOR:'kr', LTU:'lt', LUX:'lu', LVA:'lv', MEX:'mx', NLD:'nl', NOR:'no', NZL:'nz', POL:'pl', PRT:'pt', SVK:'sk', SVN:'si', SWE:'se', TUR:'tr', USA:'us' };

        // --- GLOBAL STATE ---
        let peer, connections = {}; 
        let myId, hostId = null;
        let myDeck = [], hostMasterDecks = {}, hostPot = []; 
        let isHost = false, selectedYear = "2024";
        let players = []; 
        let turnIdx = 0;
        let currentResultData = null;

        function getStat(card, key, targetYear) {
            let year = parseInt(targetYear);
            while (year >= 2018) {
                const val = card.dataMap[key][year.toString()];
                if (val !== null && val !== undefined) return { value: val, year: year };
                year--;
            }
            return { value: 0, year: 'N/A' };
        }

        // --- EVENTS ---
        document.getElementById('btn-host').onclick = initHost;
        document.getElementById('btn-join').onclick = initJoin;
        document.getElementById('btn-start').onclick = hostBegin;
        document.getElementById('overlay-continue-btn').onclick = nextRound;

        // --- NETVÆRK ---
        function initHost() {
            isHost = true;
            selectedYear = document.getElementById('game-year').value;
            peer = new Peer();
            peer.on('open', id => {
                myId = id;
                document.getElementById('host-info').style.display = 'block';
                document.getElementById('peer-id-display').innerText = id;
                players.push({id: id, name: "Vært", active: true});
                renderLobby();
            });
            peer.on('connection', conn => {
                connections[conn.peer] = conn;
                conn.on('data', data => handleData(data, conn.peer));
                conn.on('close', () => { 
                    const p = players.find(x => x.id === conn.peer);
                    if(p) p.active = false; 
                    broadcast({type: 'LOBBY', players}); 
                });
            });
        }

        function initJoin() {
            const hId = document.getElementById('join-id').value.trim();
            const uName = document.getElementById('join-name').value || "Spiller";
            if(!hId) return alert("Indtast Værtens ID");
            
            hostId = hId; 
            peer = new Peer();
            peer.on('open', id => {
                myId = id;
                const conn = peer.connect(hostId);
                conn.on('open', () => {
                    connections[hostId] = conn; 
                    conn.send({type: 'JOIN', name: uName});
                    document.getElementById('lobby-view').innerHTML = "<h3>Forbundet! Venter på start...</h3>";
                });
                conn.on('data', data => handleData(data, hostId));
                conn.on('error', () => alert("Kunne ikke oprette forbindelse."));
            });
        }

        function handleData(data, senderId) {
            if (isHost) {
                if (data.type === 'JOIN') {
                    let idx = players.findIndex(p => p.id === senderId);
                    if(idx > -1) players[idx] = {id: senderId, name: data.name, active: true};
                    else players.push({id: senderId, name: data.name, active: true});
                    broadcast({type: 'LOBBY', players}); renderLobby();
                }
                if (data.type === 'PICK_CATEGORY') {
                    processHostRound(data.cat);
                }
            }

            switch(data.type) {
                case 'LOBBY': players = data.players; break;
                case 'START':
                    myDeck = data.myDeck;
                    selectedYear = data.year;
                    turnIdx = data.turnIdx;
                    players = data.players;
                    startBoard();
                    break;
                case 'RESULT':
                    currentResultData = data;
                    renderResult(data);
                    break;
            }
        }

        function broadcast(data) { Object.values(connections).forEach(c => c.send(data)); }
        
        function sendToHost(data) { 
            if (isHost) {
                handleData(data, myId);
            } else if (hostId && connections[hostId]) {
                connections[hostId].send(data);
            } else {
                alert("Forbindelsen til Værten er mistet.");
            }
        }

        // --- HOST LOGIK (OVERDOMMER) ---
        async function hostBegin() {
            const codes = Object.keys(countries).sort(() => Math.random() - 0.5);
            const allData = {};
            for(let code of codes) {
                const res = await fetch(`./data/${code}.json`); 
                const json = await res.json();
                json.code = code;
                allData[code] = json;
            }

            players.forEach(p => { hostMasterDecks[p.id] = []; });
            codes.forEach((code, i) => {
                const pId = players[i % players.length].id;
                hostMasterDecks[pId].push(allData[code]);
            });

            players.forEach(p => {
                const msg = { type: 'START', myDeck: hostMasterDecks[p.id], year: selectedYear, players, turnIdx: 0 };
                if (p.id === myId) handleData(msg, myId);
                else connections[p.id].send(msg);
            });
        }

        function processHostRound(cat) {
            const meta = indicatorMeta[cat];
            let bestVal = meta.lowWins ? Infinity : -Infinity;
            let winners = [];
            let roundDetails = {};

            players.forEach(p => {
                if (!p.active) return;
                const pDeck = hostMasterDecks[p.id];
                if (!pDeck || pDeck.length === 0) return;
                
                const card = pDeck[0];
                const stat = getStat(card, cat, selectedYear);
                roundDetails[p.id] = { value: stat.value, year: stat.year, cardCode: card.code };

                // Sejrs-logik
                if (meta.lowWins) {
                    if (stat.value < bestVal) { bestVal = stat.value; winners = [p.id]; }
                    else if (stat.value === bestVal) winners.push(p.id);
                } else {
                    if (stat.value > bestVal) { bestVal = stat.value; winners = [p.id]; }
                    else if (stat.value === bestVal) winners.push(p.id);
                }
            });

            // Flyt top-kortene til puljen
            const roundCards = [];
            players.forEach(p => {
                if (p.active && hostMasterDecks[p.id].length > 0) {
                    roundCards.push(hostMasterDecks[p.id].shift());
                }
            });
            hostPot.push(...roundCards);

            let nextTurn;
            let winCardsToSend = [];

            if (winners.length === 1) {
                const winnerId = winners[0];
                winCardsToSend = [...hostPot];
                hostMasterDecks[winnerId].push(...hostPot);
                hostPot = [];
                nextTurn = players.findIndex(p => p.id === winnerId);
            } else {
                nextTurn = (turnIdx + 1) % players.length;
                while(!players[nextTurn].active) nextTurn = (nextTurn + 1) % players.length;
            }

            const resultMsg = {
                type: 'RESULT',
                winners,
                details: roundDetails,
                catName: meta.name,
                potSize: hostPot.length,
                winCards: winCardsToSend,
                nextTurn
            };
            broadcast(resultMsg);
            handleData(resultMsg, myId);
        }

        // --- SPIL FLOW ---
        function startBoard() {
            document.getElementById('setup-container').style.display = 'none';
            document.getElementById('game-board').style.display = 'flex';
            updateUI();
        }

        function updateUI() {
            if (myDeck.length === 0) {
                document.getElementById('game-status').innerText = "UDE AF SPILLET";
                return;
            }
            const card = myDeck[0];
            const activeP = players[turnIdx];
            const isMe = activeP.id === myId;
            const turnName = isMe ? (isHost ? "Vært (Dig)" : activeP.name + " (Dig)") : activeP.name;

            document.getElementById('country-name').innerText = countries[card.code];
            document.getElementById('country-flag').src = `https://flagcdn.com/w160/${iso3to2[card.code]}.png`;
            document.getElementById('my-deck-count').innerText = myDeck.length;
            document.getElementById('turn-display').innerText = "Tur: " + turnName;
            document.getElementById('game-status').innerText = isMe ? "DIN TUR! Vælg et tal." : "Venter på " + activeP.name;

            const list = document.getElementById('stat-list');
            list.innerHTML = '';
            Object.keys(indicatorMeta).forEach(key => {
                const stat = getStat(card, key, selectedYear);
                const li = document.createElement('li');
                li.className = isMe ? 'stat-item' : 'stat-item disabled';
                li.innerHTML = `<div>${indicatorMeta[key].name}${stat.year != selectedYear ? `<span class="fallback-year">(${stat.year})</span>` : ''}</div>
                                <span class="stat-value">${stat.value.toFixed(2)}</span>`;
                if(isMe) li.onclick = () => sendToHost({type: 'PICK_CATEGORY', cat: key});
                list.appendChild(li);
            });
        }

        function renderResult(data) {
            const isWar = data.winners.length > 1;
            let html = `<div style="color:var(--gold); margin-bottom:10px; font-weight:bold;">Kategori: ${data.catName}</div>`;
            Object.entries(data.details).forEach(([id, res]) => {
                const p = players.find(x => x.id === id).name;
                html += `<div style="margin-bottom:8px; text-align:left; border-bottom: 1px solid #444; padding-bottom:4px;">${p} (${countries[res.cardCode]}): <b>${res.value.toFixed(2)}</b></div>`;
            });

            document.getElementById('overlay-war').style.display = isWar ? 'block' : 'none';
            document.getElementById('overlay-title').innerText = isWar ? "KRIG!" : "RESULTAT";
            document.getElementById('overlay-details').innerHTML = html;
            document.getElementById('overlay-winner').innerText = isWar ? "Puljen vokser!" : "VINDER: " + players.find(p => p.id === data.winners[0]).name;
            
            document.getElementById('overlay-continue-btn').style.display = 'inline-block';
            document.getElementById('overlay').style.display = 'flex';
        }

        function nextRound() {
            const res = currentResultData;
            myDeck.shift(); 
            if (res.winners.length === 1 && res.winners.includes(myId)) {
                myDeck.push(...res.winCards); 
            }
            document.getElementById('overlay').style.display = 'none';
            turnIdx = res.nextTurn;
            document.getElementById('pot-count').innerText = res.potSize;
            if(myDeck.length === 0) players.find(p => p.id === myId).active = false;
            currentResultData = null;
            updateUI();
        }

        function renderLobby() {
            document.getElementById('connected-players').innerHTML = players.map(p => `<span class="player-tag">${p.name}</span>`).join('');
            if(isHost && players.length >= 2) document.getElementById('btn-start').disabled = false;
        }
    </script>
</body>
</html>
